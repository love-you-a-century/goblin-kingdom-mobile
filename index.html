<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>哥布林王國v5.82</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=MedievalSharp&display=swap"
        rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>

<body class="p-4 md:p-6" x-data="game()">

    <div class="dice-tray-container" :class="{ 'visible': modals.dice.isOpen }">
        <h2 class="text-2xl font-medieval text-amber-200 mb-4" x-text="modals.dice.title"></h2>
        
        <div class="dice-contest-grid">
            
            <div class="dice-column">
                <h3 class="text-xl font-bold text-green-400">我方</h3>
                <div class="dice-items-grid">
                    <template x-for="(roll, index) in modals.dice.sides.player" :key="'p' + index">
                        <div class="dice-container">
                            <div :class="['dice-display', `d${roll.sides}`, roll.isRolling ? 'rolling' : '']"
                                x-text="roll.isRolling ? '?' : roll.result">
                            </div>
                            <p class="text-md h-6" x-text="roll.isRolling ? '滾動中...' : `擲出 ${roll.result} 點！`"></p>
                        </div>
                    </template>
                </div>
            </div>
            
            <div class="dice-column">
                <h3 class="text-xl font-bold text-red-400">敵方</h3>
                <div class="dice-items-grid">
                    <template x-for="(roll, index) in modals.dice.sides.opponent" :key="'o' + index">
                        <div class="dice-container">
                            <div :class="['dice-display', `d${roll.sides}`, roll.isRolling ? 'rolling' : '']"
                                x-text="roll.isRolling ? '?' : roll.result">
                            </div>
                            <p class="text-md h-6" x-text="roll.isRolling ? '滾動中...' : `擲出 ${roll.result} 點！`"></p>
                        </div>
                    </template>
                </div>
            </div>

        </div>
    </div>

    <div class="max-w-7xl mx-auto">

        <audio x-ref="audioPlayer" loop></audio>

        <template x-if="screen === 'api_key_input'">
            <div id="api-key-screen" x-cloak>
                <div class="max-w-xl mx-auto game-container relative p-8 rounded-lg pt-10 text-center">
                    <h1 class="game-title font-medieval">設定 API 金鑰</h1>
                    <p class="text-left text-gray-300 mb-4">
                        本遊戲的 AI 敘事功能（如序幕、誕生、繁衍故事）由 Google Gemini Pro 提供技術支援。為了使用這些功能，您需要一組自己的 API 金鑰。
                    </p>
                    <p class="text-left text-gray-300 mb-4">
                        您可以點擊下方連結免費取得。取得後，請將金鑰貼入輸入框中。
                    </p>
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-400 hover:underline mb-4 inline-block">
                        前往 Google AI Studio 取得免費 API 金鑰
                    </a>

                    <input type="text" x-model="userApiKey" class="w-full bg-gray-700 border-2 border-gray-600 rounded px-3 py-2 mb-6" placeholder="請在此貼上您的 API 金鑰...">

                    <div class="flex justify-center space-x-4">
                        <button @click="submitApiKey()" class="btn btn-primary">儲存金鑰並開始遊戲</button>
                        <button @click="proceedToGame()" class="btn btn-secondary">跳過，直接開始</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-4">（金鑰將只會儲存在您的瀏覽器本機，不會上傳到任何伺服器。）</p>
                </div>
            </div>
        </template>

        <!-- 遊戲開場敘事畫面 -->
        <template x-if="screen === 'intro'">
            <div id="intro-screen" x-cloak>
                <div class="max-w-3xl mx-auto game-container relative p-8 rounded-lg flex flex-col items-center pt-10">
                    <h1 class="game-title font-medieval">序幕</h1>
                    <div class="min-h-[300px] w-full flex items-center justify-center p-4 bg-black bg-opacity-20 rounded mb-4">
                        <p class="text-lg leading-relaxed">
                            (陰沉的天空下著濛濛細雨，冰冷的泥土沾滿全身)<br>
                            <br>
                            我，一個在現代都市中，忽然結束生命的人，卻在睜開雙眼時，發現自己身處一個截然不同的世界。沒有高樓大廈，沒有霓虹燈火，只有一個荒蕪一人的部落。<br>
                            當我試圖撐起身體，映入眼簾的，是一雙粗糙的綠色手掌。<br>
                            <br>
                            「不，這不是我的手...」我開始低頭審視著自己<br>
                            <br>
                            鏡面般的水窪倒映出一個面目猙獰長著尖耳、獠牙的生物——哥布林。<br>
                            <br>
                            「最弱小的魔物？」一個在冒險者眼中等同於經驗值的存在。<br>
                            <br>
                            恐懼與絕望再次襲來，但在這荒涼的世界裡，沒有時間自怨自艾，一股原始的求生本能取代了所有負面情緒。<br>
                            我知道，在這個充滿敵意的世界，必須拋棄過去的一切，從零開始。<br>
                            沒有同伴，沒有退路，必須獨自面對。<br>
                            掠奪、繁衍，用最原始的方式在這片土地上掙扎求生，建立只屬於自己的哥布林王國。<br>
                            <br>
                            <br>
                            ====故事不是從勇者屠龍開始，而是從一隻哥布林====<br>
                            <br>
                            <br>
                            <br>
                            <br>
                            <br>
                            <br>
                            <br>
                            <br>
                            ？？？？「祝zj6...u.3的...死j;6回ejo ...」<br>
                        </p>
                    </div>
                <button @click="screen = 'creation'" class="btn btn-primary">開始遊戲</button>
            </div>
        </template>

        <!-- 角色創建畫面 -->
        <template x-if="screen === 'creation'">
            <div id="creation-screen" x-cloak>
                <div class="max-w-4xl mx-auto game-container relative p-8 rounded-lg pt-10">
                    <h1 class="game-title font-medieval">創建你的哥布林王</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <input type="text" x-model="creation.name" class="w-full bg-gray-700 border-2 border-gray-600 rounded px-3 py-2" placeholder="哥布林名稱">
                            <input type="number" x-model.number="creation.height" class="w-full bg-gray-700 border-2 border-gray-600 rounded px-3 py-2" placeholder="身高">
                            <input type="number" x-model.number="creation.penisSize" class="w-full bg-gray-700 border-2 border-gray-600 rounded px-3 py-2" placeholder="王的雄風 (公分)">
                            <textarea x-model="creation.appearance" rows="4" class="w-full bg-gray-700 border-2 border-gray-600 rounded px-3 py-2" placeholder="外貌描述..."></textarea>
                        </div>
                        <div class="space-y-4">
                            <h2 class="text-xl font-bold text-center text-amber-200">能力點數</h2>
                            <p class="text-center mb-2">剩餘點數:
                                <span x-text="creation.pointsRemaining" :class="creation.pointsRemaining < 0 ? 'text-red-400' : 'text-green-400'"></span>
                            </p>
                            <p class="text-center text-yellow-400 h-6" x-text="creation.statWarningMessage"></p>
                            <template x-for="stat in Object.keys(creation.stats)" :key="stat">
                                <div class="space-y-2">
                                    <div class="flex items-center justify-between">
                                        <label class="font-bold capitalize" x-text="STAT_NAMES[stat]"></label>
                                        <div class="flex items-center">
                                            <button @click="updateStat(stat, creation.stats[stat] - 1)" class="px-3 py-1 bg-gray-700 rounded-l-md">-</button>
                                            <input type="number" min="0" max="100" :value="creation.stats[stat]" @input="updateStat(stat, $event.target.value)" class="stat-input w-16 text-center bg-gray-800 border-y-2 border-gray-600 py-1">
                                            <button @click="updateStat(stat, creation.stats[stat] + 1)" class="px-3 py-1 bg-gray-700 rounded-r-md">+</button>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div class="text-center mt-8 space-x-4">
                        <button @click="createCharacter()" :disabled="creation.pointsRemaining !== 0" class="btn btn-primary text-xl">創建我的哥布林王</button>
                        <button x-show="hasSaveFile" @click="loadGame()" class="btn btn-secondary text-xl">讀取進度</button>
                    </div>
                </div>
            </div>
        </template>

        <template x-if="screen === 'birth_narrative'">
            <div id="birth-narrative-screen" x-cloak>
                <div class="max-w-3xl mx-auto game-container relative p-8 rounded-lg flex flex-col items-center pt-10">   
                    <h1 class="game-title font-medieval">王的誕生</h1>                
                    <div class="min-h-[300px] w-full flex items-center justify-center p-4 bg-black bg-opacity-20 rounded mb-4">
                        <div x-show="modals.narrative.isAwaitingConfirmation" class="text-center">
                            <p class="mb-4">是否要使用 AI 生成您的誕生故事？<br>這將根據您創建的角色資訊生成一段獨特的背景描述。</p>
                            <button @click="generateBirthNarrative()" class="btn btn-primary">使用 AI 生成誕生故事</button>
                        </div>
                        <div x-show="modals.narrative.isLoading" class="loader"></div>
                        <p x-show="!modals.narrative.isLoading && !modals.narrative.isAwaitingConfirmation" x-html="modals.narrative.content" class="text-lg leading-relaxed"></p>
                    </div>   
                    <button @click="screen = 'tutorial_query'" class="btn btn-primary">繼續</button>
                </div> 
            </div>
        </template>

        <template x-if="screen === 'rebirth'">
            <div id="rebirth-screen" x-cloak>
                <div class="max-w-4xl mx-auto game-container relative p-8 rounded-lg pt-10">
                    <h1 class="game-title font-medieval">哥布林王之重生</h1>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-4">
                            <input type="text" x-model="rebirth.name" class="w-full bg-gray-900 border-2 border-gray-600 rounded px-3 py-2 text-gray-400" placeholder="哥布林名稱" disabled>
                            <input type="number" x-model.number="rebirth.height" class="w-full bg-gray-700 border-2 border-gray-600 rounded px-3 py-2" placeholder="身高">
                            <input type="number" x-model.number="rebirth.penisSize" class="w-full bg-gray-700 border-2 border-gray-600 rounded px-3 py-2" placeholder="王的雄風 (公分)">
                            <textarea x-model="rebirth.appearance" rows="4" class="w-full bg-gray-700 border-2 border-gray-600 rounded px-3 py-2" placeholder="外貌描述..."></textarea>
                        </div>
                        <div class="space-y-4">
                            <h2 class="text-xl font-bold text-center text-amber-200">重新分配能力</h2>
                            <p class="text-center mb-2">
                                剩餘點數: <span x-text="rebirth.pointsRemaining" :class="rebirth.pointsRemaining < 0 ? 'text-red-400' : 'text-green-400'"></span>
                                / 總點數: <span x-text="rebirth.totalPoints"></span>
                            </p>
                            <p class="text-center text-gray-400 h-6">（每項能力值至少需要 1 點）</p>
                            <template x-for="stat in Object.keys(rebirth.stats)" :key="stat">
                                <div class="space-y-2">
                                    <div class="flex items-center justify-between">
                                        <label class="font-bold capitalize" x-text="STAT_NAMES[stat]"></label>
                                        <div class="flex items-center">
                                            <button @click="updateRebirthStat(stat, rebirth.stats[stat] - 1)" class="px-3 py-1 bg-gray-700 rounded-l-md">-</button>
                                            <input type="number" min="1" max="999" x-model.number="rebirth.stats[stat]" @input="updateRebirthStat(stat, $event.target.value)" class="stat-input w-16 text-center bg-gray-800 border-y-2 border-gray-600 py-1">
                                            <button @click="updateRebirthStat(stat, rebirth.stats[stat] + 1)" class="px-3 py-1 bg-gray-700 rounded-r-md">+</button>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>
                    <div class="text-center mt-8">
                        <button @click="confirmRebirth()" class="btn btn-primary text-xl">確認重生</button>
                    </div>
                </div>
            </div>
        </template>

        <!-- AI繁衍畫面 -->
        <template x-if="screen === 'breeding_narrative'">
            <div id="breeding-narrative-screen" x-cloak>
                <div class="max-w-3xl mx-auto game-container relative p-8 rounded-lg flex flex-col items-center pt-10">
                    <h1 class="game-title font-medieval">繁衍</h1>
                    <div class="min-h-[300px] w-full flex items-center justify-center p-4 bg-black bg-opacity-20 rounded mb-4">
                        <div x-show="modals.narrative.isLoading" class="loader"></div>
                        <p x-show="!modals.narrative.isLoading" x-html="modals.narrative.content || '請選擇您的行動...'"></p>
                    </div>
                    <div class="w-full space-y-2">
                        <div class="grid grid-cols-3 gap-2">
                            <button @click="confirmAndStartBreedingNarrative()" class="btn btn-primary" :disabled="modals.narrative.hasBred || modals.narrative.isLoading">
                                使用 AI 敘事
                            </button>
                            <button @click="generateNarrativeSegment('繼續')" class="btn btn-secondary" :disabled="!modals.narrative.content || modals.narrative.hasBred || modals.narrative.isLoading">
                                繼續
                            </button>
                            <button @click="generateNarrativeSegment('將巨根挺入')" class="btn btn-secondary" :disabled="!modals.narrative.content || modals.narrative.hasBred || modals.narrative.isLoading">
                                將巨根挺入
                            </button>
                        </div>
                        <div class="grid grid-cols-1 gap-2">
                            <button @click="confirmAndNarrateBreeding()" class="btn btn-info" :disabled="modals.narrative.hasBred || modals.narrative.isLoading">
                                繁衍 (觸發AI結局)
                            </button>
                            <button x-show="modals.narrative.hasBred" @click="finalizeBreedingAndReturn()" class="btn btn-success">
                                返回部落畫面
                            </button>
                            <button x-show="!modals.narrative.hasBred" @click="executeQuickBreedingAndReturn()" class="btn btn-danger">
                                直接繁衍 (跳過敘事)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <!-- 教學詢問畫面 -->
        <template x-if="screen === 'tutorial_query'">
            <div id="tutorial-query-screen" x-cloak>
                <div class="max-w-xl mx-auto game-container relative p-8 rounded-lg pt-10 text-center">
                    <h1 class="game-title font-medieval">引導</h1>
                    <p class="text-lg mb-6">王，您已降臨於此。本遊戲系統龐大，若您是初次遊玩，建議善用畫面右下角的「輔助說明」功能來熟悉遊戲操作。</p>
                    <div class="flex justify-center space-x-4">
                        <button @click="screen = 'tribe'" class="btn btn-primary">我明白了，開始遊戲</button>
                    </div>
                </div>
            </div>
        </template>

        <!-- 主遊戲畫面 (部落中心) -->
        <template x-if="screen === 'tribe'">
            <div id="tribe-screen" x-cloak x-init="initializeTribe()">
                <template x-if="player && screen === 'tribe'">
                    <div class="max-w-7xl mx-auto">
                        <div class="space-y-6">
                            <div class="game-container relative p-4 rounded-lg pt-10">
                                <h2 class="game-title font-medieval">王之號令</h2>
                                <div class="grid grid-cols-3 md:grid-cols-5 gap-4">
                                    <button @click="handleRaidButtonClick()" 
                                            class="btn btn-primary" 
                                            title="必須先建造地牢才能抓捕俘虜">
                                        出擊掠奪
                                    </button>
                                    <button @click="handleConstructionClick()" 
                                            class="btn btn-primary">
                                        部落建設
                                    </button>
                                    <button @click="openMerchant()" 
                                            class="btn btn-primary" 
                                            :disabled="isMerchantButtonDisabled" 
                                            title="旅行商人來訪時才能進入">
                                        商人營地 <span x-show="merchant.isPresent" class="text-yellow-300">(來訪中)</span>
                                    </button>
                                    <button @click="openDispatchModal()" class="btn btn-primary">
                                        部落派遣
                                    </button>
                                    <button @click="openSkillTree()" 
                                            class="btn btn-primary"
                                            :disabled="player.skillPoints === 0"
                                            title="需要獲得技能點才能使用">
                                        技能樹 <span x-show="player.skillPoints > 0" class="text-yellow-300" x-text="`(${player.skillPoints})`"></span>
                                    </button>
                                </div>
                            </div>
                            <div class="game-container relative p-4 rounded-lg pt-10 h-full">
                                <h2 class="game-title font-medieval">王國總覽</h2>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6">
                                    <div>
                                        <div class="flex gap-x-4">
                                            <div class="w-1/3 flex-shrink-0">
                                                <div class="w-full h-48 bg-gray-800 rounded flex items-center justify-center text-gray-500">
                                                    <template x-if="player.avatarUrl">
                                                        <img :src="player.avatarUrl" class="w-full h-full object-cover rounded" alt="Player Avatar">
                                                    </template>
                                                    <template x-if="!player.avatarUrl">
                                                        <span>頭像</span>
                                                    </template>
                                                </div>
                                            </div>
                                            <div class="w-2/3 space-y-2">
                                                <p><strong>名稱:</strong> <span class="font-accent" x-text="player.name"></span></p>
                                                <p class="font-bold text-amber-200" :class="{'text-red-400': isStarving}">總能力值
                                                    <span x-show="isStarving">(飢餓中 -25%)</span>:
                                                </p>
                                                <p class="text-sm"><strong>生命值:</strong>
                                                    <span x-text="player.currentHp"></span> / <span x-text="player.getBaseMaxHp(isStarving)"></span>
                                                    <span class="text-green-400" x-show="player.getPartyHpBonus(isStarving) !== 0" x-text="` (+${player.getPartyHpBonus(isStarving)})`"></span>
                                                    <span class="text-blue-400" x-show="player.getEquipmentHpBonus() !== 0" x-text="formatBonus(player.getEquipmentHpBonus())"></span>
                                                </p>
                                                <ul class="space-y-1 text-sm pt-1">
                                                    <template x-for="stat in ['strength', 'agility', 'intelligence', 'luck']" :key="stat">
                                                        <li class="flex items-center justify-between">
                                                            <div>
                                                                <span class="capitalize" x-text="STAT_NAMES[stat]"></span>:
                                                                <span x-text="player.stats[stat]"></span>
                                                                <span class="text-yellow-400 font-bold" x-show="tempStatIncreases[stat] > 0" x-text="` (+${tempStatIncreases[stat]})`"></span>
                                                                <span class="text-green-400" x-show="player.getPartyBonus(stat) !== 0" x-text="` (+${player.getPartyBonus(stat)})`"></span>
                                                                
                                                                <span class="text-blue-400" x-text="formatBonus(player.getTotalStat(stat, isStarving) - player.stats[stat] - player.getPartyBonus(stat))"></span>

                                                                <span class="text-red-400" x-show="isStarving" x-text="` -> ${player.getTotalStat(stat, isStarving)}`"></span>
                                                            </div>
                                                            <button @click="addTempPoint(stat)" x-show="player.attributePoints > 0 && (player.attributePoints - Object.values(tempStatIncreases).reduce((a, b) => a + b, 0)) > 0" class="btn btn-sm btn-primary ml-2 w-8" >+</button>
                                                        </li>
                                                    </template>
                                                </ul>
                                                <div x-show="Object.values(tempStatIncreases).reduce((a, b) => a + b, 0) > 0" class="mt-2 text-right space-x-2">
                                                    <button @click="confirmAttributePoints()" class="btn btn-sm btn-success">確認分配</button>
                                                    <button @click="cancelAttributePoints()" class="btn btn-sm btn-secondary">取消</button>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-4 text-sm text-center border-y border-gray-700 py-1 my-2">
                                            <div class="col-span-1">
                                                <span class="text-gray-400 block text-xs">日期</span>
                                                <span class="text-xs" x-text="`第 ${year} 年 ${month} 月 ${currentDate} 日`"></span>
                                            </div>
                                            <div>
                                                <span class="text-gray-400 block text-xs">總繁衍次數</span>
                                                <span x-text="totalBreedingCount"></span>
                                            </div>
                                            <div>
                                                <span class="text-gray-400 block text-xs">能力點</span>
                                                <span x-text="player.attributePoints - Object.values(tempStatIncreases).reduce((a, b) => a + b, 0)"></span>
                                            </div>
                                            <div>
                                                <span class="text-gray-400 block text-xs">技能點</span>
                                                <span x-text="player.skillPoints"></span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="space-y-4 mt-4 md:mt-0">
                                        <div>
                                            <p class="mt-4 font-bold text-amber-200 flex justify-between items-center">
                                                <span>當前裝備:</span>
                                                <button @click="openPlayerEquipment()" class="btn btn-xs btn-secondary">管理裝備</button>
                                            </p>
                                            <div class="space-y-1 text-sm">
                                                <template x-for="slot in Object.keys(player.equipment)" :key="slot">
                                                    <div class="flex justify-between items-center">
                                                        <span class="capitalize" x-text="EQUIPMENT_SLOTS[slot] || slot"></span>
                                                        <template x-if="player.equipment[slot]">
                                                            <div class="text-right">
                                                                <span :style="{ color: player.equipment[slot].quality.color }" x-text="player.equipment[slot].name"></span>
                                                                <button @click="unequipItem(slot, player)" class="btn btn-xs btn-secondary ml-2">卸下</button>
                                                            </div>
                                                        </template>
                                                        <template x-if="!player.equipment[slot]">
                                                            <span class="text-gray-500">-- 無 --</span>
                                                        </template>
                                                    </div>
                                                </template>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-x-4 pt-4 mt-4 border-t border-gray-700">
                                            <div>
                                                <p class="font-bold text-amber-200">部落資源:</p>
                                                <ul class="list-disc list-inside ml-4 text-sm">
                                                    <li>食物: <span x-text="resources.food"></span> / <span x-text="foodCapacity"></span></li>
                                                    <li>木材: <span x-text="resources.wood"></span> / <span x-text="woodCapacity"></span></li>
                                                    <li>礦石: <span x-text="resources.stone"></span> / <span x-text="stoneCapacity"></span></li>
                                                </ul>
                                            </div>
                                            <div>
                                                <p class="font-bold text-amber-200">部落人口:</p>
                                                <ul class="list-disc list-inside ml-4 text-sm">
                                                    <li>夥伴: <span x-text="partners.length"></span> /
                                                        <span x-text="partnerCapacity"></span>
                                                    </li>
                                                    <li>俘虜 (總數): <span x-text="captives.length"></span> /
                                                        <span x-text="captiveCapacity"></span>
                                                    </li>
                                                    </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="game-container relative p-4 rounded-lg pt-10">
                                <h2 class="game-title font-medieval">部落日誌</h2>
                                <div class="log-panel" id="tribe" x-init="$watch('logs.tribe', () => { $nextTick(() => { $el.scrollTop = $el.scrollHeight }) })">
                                    <template x-for="entry in logs.tribe" :key="entry.id">
                                        <div :class="`log-entry ${entry.type}`" x-html="entry.message"></div>
                                    </template>
                                </div>
                            </div>
                            <div class="game-container relative p-4 rounded-lg pt-10">
                                <h2 class="game-title font-medieval">遊戲存檔</h2>
                                <div class="flex space-x-4">
                                    <button @click="saveGame()" class="btn btn-primary">儲存進度</button>
                                    <button x-show="hasSaveFile" @click="loadGame()" class="btn btn-secondary">讀取進度</button>
                                    <button @click="exportGame()" class="btn btn-secondary">輸出存檔</button>
                                </div>
                                <div class="mt-4">
                                    <textarea x-model="importSaveData" rows="4" class="w-full bg-gray-700 border-2 border-gray-600 rounded px-3 py-2" placeholder="請將備份的遊戲存檔貼到這裡..."></textarea>
                                    <button @click="importGame()" class="btn btn-primary w-full mt-2">匯入存檔</button>
                                </div>
                            </div>

                            <div id="export-save-modal" x-show="modals.exportSave.isOpen" class="modal">
                                <div class="modal-content game-container relative p-6 rounded-lg max-w-lg pt-10">
                                    <h2 class="game-title font-medieval">匯出存檔</h2>
                                    <p class="mb-4">請複製以下文字框中的所有內容，並將其妥善保存在文字檔案中。</p>
                                    <textarea x-ref="export_save_data" x-model="modals.exportSave.data" rows="8" class="w-full bg-gray-900 border-2 border-gray-600 rounded px-3 py-2 text-gray-400" readonly></textarea>
                                    <div class="text-center mt-6 flex justify-center space-x-4">
                                        <button @click="copySaveToClipboard()" class="btn btn-primary">複製到剪貼簿</button>
                                        <button @click="modals.exportSave.isOpen = false" class="btn btn-secondary">關閉</button>
                                    </div>
                                </div>
                            </div>

                            <div class="game-container relative p-4 rounded-lg pt-10">
                                <h2 class="game-title font-medieval">序號兌換</h2> 
                                <div class="flex space-x-2">
                                    <input type="text" x-ref="dlc_code_input" class="w-full bg-gray-700 border-2 border-gray-600 rounded px-3 py-2" placeholder="請輸入特典序號...">
                                    <button @click="redeemCode()" class="btn btn-primary">兌換</button>
                                </div>
                                <div class="flex space-x-4 mt-2">
                                    <span x-show="dlc.hells_knights" class="text-green-400">「王國騎士團」DLC 已成功啟用！</span>
                                    <span x-show="dlc.races_of_aetheria" class="text-green-400">「精靈與亞獸人」DLC 已成功啟用！</span>
                                </div>
                            </div>
                            <!--音樂撥放器-->
                            <div class="game-container relative p-4 rounded-lg pt-10">
                                <h2 class="game-title font-medieval">音樂設定</h2>
                                <div class="flex items-center space-x-4">
                                    <label class="btn btn-secondary cursor-pointer">
                                        <span>選擇檔案</span>
                                        <input type="file" @change="loadMusic($event)" accept="audio/*" class="hidden">
                                    </label>
                                    <button @click="toggleMusic()" class="btn btn-primary w-24" :disabled="!musicSettings.src">
                                        <span x-text="musicSettings.isPlaying ? '暫停' : '播放'"></span>
                                    </button>
                                    <div>
                                        <label for="play-scene" class="text-sm mr-2">播放場景:</label>
                                        <select x-model="musicSettings.playOnScreen" id="play-scene" class="bg-gray-700 border-2 border-gray-600 rounded px-3 py-2">
                                            <option value="tribe">部落</option>
                                            <option value="raid_selection">掠奪選擇</option>
                                            <option value="raid">掠奪地圖</option>
                                            <option value="combat">戰鬥</option>
                                            <option value="throne_room">王座之間</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </template>
    
        <!-- 掠奪選擇畫面 -->
        <template x-if="screen === 'raid_selection'">
            <div id="raid-selection-screen" x-cloak>
                <div class="max-w-2xl mx-auto game-container relative p-8 rounded-lg pt-10">
                    <h1 class="game-title font-medieval">選擇掠奪目標</h1>
                    
                    <div class="flex border-b border-gray-600 mb-4 overflow-x-auto">
                        <button @click="modals.raidSelection.activeTab = 'human'" :class="{ 'bg-gray-700 text-white': modals.raidSelection.activeTab === 'human' }" class="flex-shrink-0 py-2 px-4 rounded-t-lg">人類城市</button>
                        
                        <button @click="modals.raidSelection.activeTab = 'elf'" 
                                :class="{ 'bg-gray-700 text-white': modals.raidSelection.activeTab === 'elf', 'opacity-50': !dlc.races_of_aetheria }" 
                                class="flex-shrink-0 py-2 px-4 rounded-t-lg">
                                精靈部落
                        </button>
                        <button @click="modals.raidSelection.activeTab = 'beastkin'" 
                                :class="{ 'bg-gray-700 text-white': modals.raidSelection.activeTab === 'beastkin', 'opacity-50': !dlc.races_of_aetheria }" 
                                class="flex-shrink-0 py-2 px-4 rounded-t-lg">
                                亞獸人部落
                        </button>
                    </div>

                    <div class="space-y-4 min-h-[200px]">
                        
                        <div x-show="(modals.raidSelection.activeTab === 'elf' || modals.raidSelection.activeTab === 'beastkin') && !dlc.races_of_aetheria" 
                            class="flex items-center justify-center h-full text-yellow-400 text-lg p-8">
                            需要「精靈與亞獸人」DLC
                        </div>

                        <div x-show="modals.raidSelection.activeTab === 'human' || ((modals.raidSelection.activeTab === 'elf' || modals.raidSelection.activeTab === 'beastkin') && dlc.races_of_aetheria)">
                            <template x-for="raid in raidOptions.filter(r => r.category === modals.raidSelection.activeTab)">
                                <button @click="startRaid(raid.difficulty)" 
                                        class="w-full text-left p-4 rounded-lg transition bg-gray-700 hover:bg-gray-600"
                                        :disabled="buildings.dungeon.level === 0"
                                        :class="{ 'opacity-50 cursor-not-allowed': raid.requires && !dlc[raid.requires] }"
                                        :title="raid.requires && !dlc[raid.requires] ? '需要解鎖對應的DLC' : ''">
                                    <div>
                                        <h3 class="text-xl font-bold" x-text="raid.name"></h3>
                                        <p x-text="raid.description"></p>
                                        <p x-show="raid.requires && !dlc[raid.requires]" class="text-yellow-400 text-sm mt-1">
                                            <span x-text="raid.requires === 'hells_knights' ? '需要「王國騎士團」DLC' : '需要「精靈與亞獸人」DLC'"></span>
                                        </p>
                                    </div>
                                    <p x-show="buildings.dungeon.level === 0" class="text-red-400 text-sm mt-1">需要先建造地牢才能出擊！</p>
                                </button>
                            </template>
                        </div>
                    </div>

                    <div class="text-center mt-6">
                        <button @click="screen = 'tribe'" class="btn btn-secondary">返回部落</button>
                    </div>
                </div>
            </div>
        </template>

        <!-- 掠奪畫面 -->
        <template x-if="screen === 'raid'">
            <div id="raid-screen" x-cloak>
                <template x-if="currentRaid">
                    <div class="flex flex-col lg:flex-row gap-6">
                        <div class="flex-shrink-0 lg:w-1/3 space-y-6">
                            <div class="game-container relative p-4 rounded-lg pt-10">
                                <h2 class="game-title font-medieval">掠奪指令</h2>
                                <div class="grid grid-cols-2 gap-4">
                                    <button @click="scoutEnvironment()" class="btn btn-primary" :disabled="!canScoutEnvironment" >偵查環境</button>
                                    <button @click="modals.raidStatus.isOpen = true" class="btn btn-secondary">查看狀態</button>

                                    <button @click="modals.raidCaptives.isOpen = true" class="btn btn-secondary">查看俘虜</button>

                                    <button @click="sneakPastGuards()" class="btn btn-primary" x-show="currentRaid.currentZoneIndex === 0 && currentRaid.currentZone.buildings.find(b => (b.type === '衛兵所' || b.type === '前線哨站') && b.occupants.length > 0)">潛行繞過守軍</button>
                                    <button @click="advanceToNextZone()" class="btn btn-secondary" :disabled="!canAdvance()">深入內城</button>
                                    <button @click="handleRetreatAction()" class="btn btn-danger col-span-full">
                                        <span x-text="currentRaid && currentRaid.currentZoneIndex > 0 ? '撤退回上層' : '脫離城鎮'"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="flex-grow flex flex-col gap-6">
                            <div class="game-container relative p-4 rounded-lg pt-10 flex-grow">
                                <h2 class="game-title font-medieval" x-text="(currentRaid?.currentZone?.name || '') + ' 地圖'"></h2>
                                <div 
                                    class="map-container-responsive"
                                    x-ref="mapContainer"
                                    x-init="() => {
                                        const observer = new ResizeObserver(() => {
                                            if ($refs.mapContainer) {
                                                mapScale = $refs.mapContainer.offsetWidth / MAP_WIDTH;
                                            }
                                        });
                                        observer.observe($refs.mapContainer);
                                    }"
                                >
                                    <div class="map-canvas" :style="`transform: scale(${mapScale});`">
                                        <div class="relative bg-gray-800" :style="`width: ${MAP_WIDTH}px; height: ${MAP_HEIGHT}px;`">
                                            <div class="absolute top-0 left-0 right-0 p-2 bg-black bg-opacity-40 text-center text-white">
                                                <span class="font-bold text-lg" x-text="currentRaid?.locationName"></span> | 
                                                <span>剩餘時間: </span>
                                                <span class="font-bold" :class="currentRaid?.timeRemaining < 30 ? 'text-red-400' : 'text-yellow-300'" x-text="currentRaid?.timeRemaining ?? 0"></span>
                                                <span> 分鐘</span>
                                            </div>
                                            <div class="absolute bottom-0 left-0 p-2 bg-black bg-opacity-40 text-white text-sm">
                                                <span>區域: </span>
                                                <span class="font-bold" x-text="currentRaid?.currentZone?.name"></span>
                                            </div>
                                            <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 p-2 bg-black bg-opacity-40 text-white text-sm rounded-t-lg flex items-center gap-x-3">
                                                <span title="食物">🍖 <span x-text="currentRaid?.currentZone?.resources.food ?? 0"></span></span>
                                                <span class="text-gray-600">|</span>
                                                <span title="木材">🌳 <span x-text="currentRaid?.currentZone?.resources.wood ?? 0"></span></span>
                                                <span class="text-gray-600">|</span>
                                                <span title="礦石">⛏️ <span x-text="currentRaid?.currentZone?.resources.stone ?? 0"></span></span>
                                            </div>
                                            <div class="absolute bottom-0 right-0 p-2 bg-black bg-opacity-40 text-white text-sm">
                                                <span>攜帶俘虜: </span>
                                                <span class="font-bold" x-text="currentRaid?.carriedCaptives.length ?? 0"></span> /
                                                <span class="font-bold" x-text="carryCapacity"></span>
                                            </div>

                                            <template x-for="building in currentRaid.currentZone.buildings" :key="building.id">
                                                <div x-show="building.scoutState !== 'hidden'"
                                                    @click="handleMapClick(building, $event)" 
                                                    class="absolute border-2 border-gray-500 bg-gray-700/50 flex flex-col items-center justify-center text-center p-1 cursor-pointer hover:border-yellow-400" 
                                                    :style="`left:${building.x}px; top:${building.y}px; width:${building.width}px; height:${building.height}px;`" 
                                                    :class="{'border-yellow-400': selectedTarget && selectedTarget.id === building.id}">
                                                    <span class="text-xs leading-tight" x-text="building.type + (building.scoutState === 'scouted' ? building.postScoutText : '')"></span>
                                                </div>
                                            </template>
                                            <template x-for="enemyGroup in currentRaid.currentZone.enemies" :key="enemyGroup[0].id">
                                                <div x-show="enemyGroup[0].scoutState !== 'hidden'"
                                                    @click="handleMapClick(enemyGroup, $event)" 
                                                    class="absolute w-4 h-4 rounded-full border-2 border-black cursor-pointer transform -translate-x-1/2 -translate-y-1/2 hover:scale-150 transition-transform" 
                                                    :class="[getUnitColor(enemyGroup), {'ring-2 ring-offset-2 ring-offset-gray-800 ring-yellow-400': selectedTarget && selectedTarget[0] && selectedTarget[0].id === enemyGroup[0].id}]" 
                                                    :style="`left:${enemyGroup[0].x}px; top:${enemyGroup[0].y}px;`">
                                                </div>
                                            </template>
                                            
                                            <div class="absolute w-5 h-5 rounded-full border-2 border-black transition-all duration-300" :class="getUnitColor(player)" :style="`left:${playerMapPosition.x}px; top:${playerMapPosition.y}px;`"></div>
                                            <template x-if="selectedTarget">
                                                <div class="absolute bg-gray-900/80 p-2 rounded-lg border border-gray-600 space-y-2 z-10" :style="getInteractionMenuPosition()">
                                                    <button x-show="(Array.isArray(selectedTarget) ? selectedTarget[0].scoutState : selectedTarget.scoutState) !== 'hidden'" 
                                                            @click="scoutTarget(selectedTarget)" 
                                                            class="btn btn-xs btn-secondary w-full">
                                                        偵查
                                                    </button>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="game-container relative p-4 rounded-lg pt-10">
                                <h2 class="game-title font-medieval">掠奪日誌</h2>
                                <div class="log-panel" id="raidl" x-init="$watch('logs.raid', () => { $nextTick(() => { $el.scrollTop = $el.scrollHeight }) })">
                                    <template x-for="entry in logs.raid" :key="entry.id">
                                        <div :class="`log-entry ${entry.type}`" x-html="entry.message"></div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </template>

        <!-- 戰鬥畫面 -->
        <template x-if="screen === 'combat'">
            <div id="combat-screen" x-cloak>
                <div class="max-w-5xl mx-auto game-container relative p-6 rounded-lg pt-10">
                    <h1 class="game-title font-medieval">戰鬥中</h1>

                    <div class="absolute top-4 right-4 flex items-center space-x-2 text-sm">
                        <span class="text-gray-400">戰鬥加速</span>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" x-model="combat.fastCombat" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-600 rounded-full peer peer-focus:ring-2 peer-focus:ring-amber-400 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-amber-500"></div>
                        </label>
                    </div>
                    <div class="flex justify-between gap-6">
                        <div>
                            <h3 class="text-lg font-bold text-green-400">我方隊伍
                                (<span x-text="combat.allies.filter(u => u.isAlive()).length"></span>)</h3>
                            <div class="space-y-1 mt-2 text-sm">
                                <template x-for="unit in combat.allies">
                                    <div class="relative" :id="'unit-display-' + unit.id">
                                        <p :class="!unit.isAlive() ? 'text-gray-500 line-through' : ''">
                                            <span x-text="unit.name"></span> - HP: <span x-text="unit.currentHp"></span> <span :id="'unit-slash-' + unit.id">/</span>
                                            <span x-text="unit.maxHp"></span>
                                            <span class="ml-2">
                                                <template x-for="effect in unit.statusEffects">
                                                    <span 
                                                        class="cursor-pointer"
                                                        x-text="STATUS_EFFECT_ICONS[effect.type]?.icon || '❓'"
                                                        :title="`${STATUS_EFFECT_ICONS[effect.type]?.description || '未知狀態'} (剩餘 ${effect.duration} 回合)`">
                                                    </span>
                                                </template>
                                            </span>
                                        </p>
                                    </div>
                                </template>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold text-red-400">敵方隊伍
                                (<span x-text="combat.enemies.filter(u => u.isAlive()).length"></span>)</h3>
                            <div class="space-y-1 mt-2 text-sm">
                                <template x-for="unit in combat.enemies">
                                    <div class="relative" :id="'unit-display-' + unit.id">
                                        <p :class="!unit.isAlive() ? 'text-gray-500 line-through' : ''">
                                            <span x-text="unit.name"></span> (<span x-text="unit.profession"></span>) - HP:
                                            <span x-text="unit.currentHp"></span> <span :id="'unit-slash-' + unit.id">/</span> <span x-text="unit.maxHp"></span>
                                            <span class="ml-2">
                                                <template x-for="effect in unit.statusEffects">
                                                    <span 
                                                        class="cursor-pointer"
                                                        x-text="STATUS_EFFECT_ICONS[effect.type]?.icon || '❓'"
                                                        :title="`${STATUS_EFFECT_ICONS[effect.type]?.description || '未知狀態'} (剩餘 ${effect.duration} 回合)`">
                                                    </span>
                                                </template>
                                            </span>
                                        </p>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    <template x-if="combat.isGoddessQnA">
                        <div class="my-6 text-center">
                            <p class="text-lg text-amber-200 mb-4" x-text="combat.goddessQuestion"></p>
                            <input type="text" x-model="combat.playerAnswer" @keydown.enter="submitGoddessAnswer()" class="w-full md:w-1/2 bg-gray-800 border-2 border-gray-600 rounded px-3 py-2 mb-4" placeholder="在此輸入你的答案...">
                            <div>
                                <button @click="submitGoddessAnswer()" class="btn btn-primary">回答</button>
                            </div>
                        </div>
                    </template>
                    <div class="mt-4">
                        <h3 class="font-bold">戰鬥紀錄</h3>
                        <div class="log-panel" id="combat" x-init="$watch('logs.combat', () => { $nextTick(() => { $el.scrollTop = $el.scrollHeight }) })">
                            <template x-for="entry in logs.combat" :key="entry.id">
                                <div :class="`log-entry ${entry.type}`" x-html="entry.message"></div>
                            </template>
                        </div>
                    </div>
                    <div class="mt-4 text-center space-x-4" x-show="!combat.isGoddessQnA">
                        <button @click="executePlayerAction('attack')" class="btn btn-primary" :disabled="!player || !player.isAlive() || combat.isProcessing || combat.playerActionTaken">普通攻擊</button>
                        <button @click="modals.combatSkills.isOpen = true" 
                                class="btn btn-primary" 
                                :disabled="!player || !player.isAlive() || combat.isProcessing || combat.playerActionTaken || learnedActiveSkills.length === 0">
                            技能
                        </button>
                        <button @click="showCombatEnemyInfo()" class="btn btn-secondary">敵方情報</button>
                        <button @click="executePlayerAction('escape')" class="btn btn-secondary" :disabled="!player || !player.isAlive() || combat.isProcessing || combat.playerActionTaken || combat.isReinforcementBattle || combat.isUnescapable">潛行脫離</button>
                    </div>
                </div>
            </div>
        </template>

        <!-- MODALS -->
        <template x-if="player">
            <div>
                <div class="modal" x-show="modals.combatSkills.isOpen" x-cloak>
                    <div class="modal-content !max-w-md game-container relative p-6 rounded-lg">
                        <h2 class="game-title font-medieval">選擇技能</h2>
                        <div class="pt-10 max-h-[80vh] overflow-y-auto">
                            <div class="space-y-3">
                                <template x-for="skill in learnedActiveSkills" :key="skill.id">
                                    <div class="p-3 border border-gray-600 rounded">
                                        <div class="flex justify-between items-center">
                                            <div>
                                                <p class="text-lg font-bold text-amber-200" x-text="skill.name + ' (Lv.' + skill.currentLevel + ')'"></p>
                                                <p class="text-xs text-gray-400" x-text="skill.description"></p>
                                            </div>
                                            <button @click="useSkill(skill.id)" class="btn btn-sm btn-primary w-24" :disabled="skill.currentCooldown > 0">
                                                <span x-show="skill.currentCooldown === 0">施放</span>
                                                <span x-show="skill.currentCooldown > 0" x-text="`冷卻 ${skill.currentCooldown} 回合`"></span>
                                            </button>
                                        </div>
                                    </div>
                                </template>
                                <p x-show="learnedActiveSkills.length === 0" class="text-center text-gray-400">你沒有已學習的主動戰鬥技能。</p>
                            </div>
                            <div class="text-right mt-6">
                                <button @click="modals.combatSkills.isOpen = false" class="btn btn-secondary">關閉</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dispatch Modal -->
                <div class="modal" x-show="modals.dispatch.isOpen" x-cloak>
                    <div class="modal-content !max-w-4xl game-container relative p-6 rounded-lg">
                        <h2 class="game-title font-medieval">部落派遣</h2>
                        <div class="pt-10 max-h-[80vh] overflow-y-auto">
                            <div class="flex border-b border-gray-600 mb-4">
                                <button @click="modals.dispatch.activeTab = 'hunting'" :class="{ 'bg-gray-700 text-white': modals.dispatch.activeTab === 'hunting' }" class="flex-1 py-2 px-4 rounded-t-lg">打獵 (食物)</button>
                                <button @click="modals.dispatch.activeTab = 'logging'" :class="{ 'bg-gray-700 text-white': modals.dispatch.activeTab === 'logging' }" class="flex-1 py-2 px-4 rounded-t-lg">伐木 (木材)</button>
                                <button @click="modals.dispatch.activeTab = 'mining'" :class="{ 'bg-gray-700 text-white': modals.dispatch.activeTab === 'mining' }" class="flex-1 py-2 px-4 rounded-t-lg">採礦 (礦石)</button>
                            </div>
                            <template x-for="task in ['hunting', 'logging', 'mining']" :key="task">
                                <div x-show="modals.dispatch.activeTab === task">
                                    <div class="grid grid-cols-2 gap-6">
                                        <div>
                                            <h3 class="text-xl font-bold mb-2 text-amber-200">可派遣的哥布林</h3>
                                            <div class="space-y-2 h-96 overflow-y-auto pr-2 border border-gray-700 rounded p-2">
                                                <template x-for="p in availablePartnersForDispatch" :key="p.id">
                                                    <div class="p-3 border border-gray-600 rounded flex justify-between items-center">
                                                        <div>
                                                            <p class="font-bold" x-text="p.name"></p>
                                                            <p class="text-xs text-gray-400">力:<span x-text="p.stats.strength"></span> 敏:<span x-text="p.stats.agility"></span> 智:<span x-text="p.stats.intelligence"></span> 運:<span x-text="p.stats.luck"></span></p>

                                                            <p class="text-sm text-green-400 mt-1" x-show="modals.dispatch.activeTab === 'hunting'">
                                                                預計產量: <strong x-text="getGoblinYield(p, 'hunting')"></strong> 食物
                                                            </p>
                                                            <p class="text-sm text-yellow-500 mt-1" x-show="modals.dispatch.activeTab === 'logging'">
                                                                預計產量: <strong x-text="getGoblinYield(p, 'logging')"></strong> 木材
                                                            </p>
                                                            <p class="text-sm text-gray-400 mt-1" x-show="modals.dispatch.activeTab === 'mining'">
                                                                預計產量: <strong x-text="getGoblinYield(p, 'mining')"></strong> 礦石
                                                            </p>
                                                        </div>
                                                        <button @click="assignToDispatch(p.id, task)" class="btn btn-sm btn-success">指派</button>
                                                    </div>
                                                </template>
                                                <p x-show="availablePartnersForDispatch.length === 0" class="text-center text-gray-400">沒有可派遣的夥伴了。</p>
                                            </div>
                                        </div>
                                        <div>
                                            <h3 class="text-xl font-bold mb-2 text-amber-200">
                                                <span x-text="{'hunting': '打獵隊', 'logging': '伐木隊', 'mining': '採礦隊'}[task]"></span>
                                                (<span x-text="dispatch[task].length"></span> / 10)
                                            </h3>
                                            <div class="space-y-2 h-96 overflow-y-auto pr-2 border border-gray-700 rounded p-2">
                                                <template x-for="p in getDispatchedPartners(task)" :key="p.id">
                                                    <div class="p-3 border border-gray-600 rounded flex justify-between items-center">
                                                        <div>
                                                            <p class="font-bold" x-text="p.name"></p>
                                                            <p class="text-xs text-gray-400">力:<span x-text="p.stats.strength"></span> 敏:<span x-text="p.stats.agility"></span> 智:<span x-text="p.stats.intelligence"></span> 運:<span x-text="p.stats.luck"></span></p>
                                                            <p class="text-sm text-green-400 mt-1" x-show="modals.dispatch.activeTab === 'hunting'">
                                                                預計產量: <strong x-text="getGoblinYield(p, 'hunting')"></strong> 食物
                                                            </p>
                                                            <p class="text-sm text-yellow-500 mt-1" x-show="modals.dispatch.activeTab === 'logging'">
                                                                預計產量: <strong x-text="getGoblinYield(p, 'logging')"></strong> 木材
                                                            </p>
                                                            <p class="text-sm text-gray-400 mt-1" x-show="modals.dispatch.activeTab === 'mining'">
                                                                預計產量: <strong x-text="getGoblinYield(p, 'mining')"></strong> 礦石
                                                            </p>
                                                        </div>
                                                        <button @click="removeFromDispatch(p.id, task)" class="btn btn-sm btn-danger">解除</button>
                                                    </div>
                                                </template>
                                                <p x-show="dispatch[task].length === 0" class="text-center text-gray-400">尚未指派任何哥布林。</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>

                            <button x-show="player.learnedSkills['tribe_forced_labor']"
                                    @click="executeForcedLabor()"
                                    class="btn btn-primary"
                                    :disabled="player.tribeSkillCooldowns['tribe_forced_labor'] > 0">
                                <span x-show="!player.tribeSkillCooldowns['tribe_forced_labor'] || player.tribeSkillCooldowns['tribe_forced_labor'] === 0">
                                    強制勞動
                                </span>
                                <span x-show="player.tribeSkillCooldowns['tribe_forced_labor'] > 0" x-text="`冷卻中 (${player.tribeSkillCooldowns['tribe_forced_labor']})`">
                                </span>
                            </button>
                                
                            <div class="text-right mt-6">
                                <button @click="modals.dispatch.isOpen = false" class="btn btn-secondary">關閉</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Construction Modal -->
                <div class="modal" x-show="modals.construction.isOpen" x-cloak>
                    <div class="modal-content game-container relative p-6 rounded-lg">
                        <h2 class="game-title font-medieval">部落建設</h2>
                        <div class="pt-10 max-h-[80vh] overflow-y-auto">
                            <div class="flex border-b border-gray-600 mb-4 overflow-x-auto">
                                <button @click="modals.construction.activeTab = 'dungeon'" :class="{ 'bg-gray-700 text-white': modals.construction.activeTab === 'dungeon' }" class="flex-shrink-0 py-2 px-4 rounded-t-lg">地牢</button>
                                <button @click="modals.construction.activeTab = 'barracks'" :class="{ 'bg-gray-700 text-white': modals.construction.activeTab === 'barracks' }" class="flex-shrink-0 py-2 px-4 rounded-t-lg">寢室</button>
                                <button @click="modals.construction.activeTab = 'warehouse'" :class="{ 'bg-gray-700 text-white': modals.construction.activeTab === 'warehouse' }" class="flex-shrink-0 py-2 px-4 rounded-t-lg">倉庫</button>
                                <button @click="modals.construction.activeTab = 'armory'" :class="{ 'bg-gray-700 text-white': modals.construction.activeTab === 'armory' }" class="flex-shrink-0 py-2 px-4 rounded-t-lg">兵工廠</button>
                                <button @click="modals.construction.activeTab = 'trainingGround'" :class="{ 'bg-gray-700 text-white': modals.construction.activeTab === 'trainingGround' }" class="flex-shrink-0 py-2 px-4 rounded-t-lg">訓練場</button>
                                <button @click="modals.construction.activeTab = 'watchtower'" :class="{ 'bg-gray-700 text-white': modals.construction.activeTab === 'watchtower' }" class="flex-shrink-0 py-2 px-4 rounded-t-lg">哨塔</button>
                                <button @click="modals.construction.activeTab = 'merchantCamp'" :class="{ 'bg-gray-700 text-white': modals.construction.activeTab === 'merchantCamp' }" class="flex-shrink-0 py-2 px-4 rounded-t-lg">商人營地</button>
                            </div>
                            <div x-show="modals.construction.activeTab === 'dungeon'">
                                <div class="flex border-b border-gray-600 mb-4">
                                    <button @click="modals.dungeon.subTab = 'manage'" :class="{ 'bg-gray-700 text-white': modals.dungeon.subTab === 'manage' }" class="flex-1 py-2 px-4 rounded-t-lg text-sm">管理俘虜</button>
                                    <button @click="modals.dungeon.subTab = 'breed'" :class="{ 'bg-gray-700 text-white': modals.dungeon.subTab === 'breed' }" class="flex-1 py-2 px-4 rounded-t-lg text-sm">繁衍後代</button>
                                    <button @click="modals.dungeon.subTab = 'upgrade'" :class="{ 'bg-gray-700 text-white': modals.dungeon.subTab === 'upgrade' }" class="flex-1 py-2 px-4 rounded-t-lg text-sm">升級</button>
                                </div>
                                <div x-show="modals.dungeon.subTab === 'manage'">
                                    <h3 class="text-xl font-bold mb-2">管理所有俘虜</h3>
                                    <p class="mb-2">總人數: <span x-text="captives.length"></span> / <span x-text="captiveCapacity"></span></p>
                                    
                                    <div class="flex items-center space-x-2 mb-4 border-b border-gray-600 pb-3">
                                        <span class="font-bold text-sm text-gray-400">篩選狀態:</span>
                                        <button @click="modals.dungeon.activeFilter = 'all'" class="btn btn-xs" :class="{ 'btn-primary': modals.dungeon.activeFilter === 'all', 'btn-secondary': modals.dungeon.activeFilter !== 'all' }">全部</button>
                                        <button @click="modals.dungeon.activeFilter = 'breedable'" class="btn btn-xs" :class="{ 'btn-primary': modals.dungeon.activeFilter === 'breedable', 'btn-secondary': modals.dungeon.activeFilter !== 'breedable' }">可繁衍</button>
                                        <button @click="modals.dungeon.activeFilter = 'pregnant'" class="btn btn-xs" :class="{ 'btn-primary': modals.dungeon.activeFilter === 'pregnant', 'btn-secondary': modals.dungeon.activeFilter !== 'pregnant' }">懷孕中</button>
                                        <button @click="modals.dungeon.activeFilter = 'mother'" class="btn btn-xs" :class="{ 'btn-primary': modals.dungeon.activeFilter === 'mother', 'btn-secondary': modals.dungeon.activeFilter !== 'mother' }">產奶中</button>
                                    </div>

                                    <div class="space-y-4 max-h-96 overflow-y-auto pr-2 border border-gray-700 rounded p-2">
                                        <template x-for="captive in filteredCaptives" :key="captive.id">
                                            <div class="p-3 border rounded" :class="{
                                                'border-pink-400/50 bg-pink-900/10': captive.isPregnant,
                                                'border-blue-400/50 bg-blue-900/10': !captive.isPregnant && captive.isMother,
                                                'border-gray-600': !captive.isPregnant && !captive.isMother
                                            }">
                                                <div class="flex justify-between items-start">
                                                    <div>
                                                        <p class="text-lg font-bold text-amber-200"><span x-text="captive.name"></span> - <span x-text="captive.profession"></span></p>
                                                        <p class="text-sm font-bold" :class="{
                                                            'text-pink-400': captive.isPregnant,
                                                            'text-blue-400': !captive.isPregnant && captive.isMother,
                                                            'text-green-400': !captive.isPregnant && !captive.isMother
                                                        }">
                                                            <span x-show="captive.isPregnant" x-text="`狀態: 懷孕中 (剩餘 ${captive.pregnancyTimer} 天)`"></span>
                                                            <span x-show="!captive.isPregnant && captive.isMother">狀態: 產奶中</span>
                                                            <span x-show="!captive.isPregnant && !captive.isMother">狀態: 可繁衍</span>
                                                            <span class="text-gray-400 font-normal" x-text="` | 繁衍: ${(captive.breedingCount || 0)} 次`"></span>
                                                        </p>
                                                    </div>
                                                    <div class="text-right text-sm"><p>魅力: <span class="font-bold" x-text="captive.stats.charisma"></span></p></div>
                                                </div>
                                                <div class="mt-2 pt-2 border-t border-gray-600 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                                    <div><strong>力量:</strong> <span x-text="captive.stats.strength"></span></div>
                                                    <div><strong>敏捷:</strong> <span x-text="captive.stats.agility"></span></div>
                                                    <div><strong>智力:</strong> <span x-text="captive.stats.intelligence"></span></div>
                                                    <div><strong>運氣:</strong> <span x-text="captive.stats.luck"></span></div>
                                                </div>
                                                <div class="text-right mt-2 space-x-2">
                                                    <button x-show="!captive.isPregnant && captive.isMother" @click="moveMotherToDungeon(captive.id)" class="btn btn-secondary btn-sm">移回可繁衍</button>
                                                    <button @click="releaseCaptive(captive.id)" class="btn btn-danger btn-sm">拋棄</button>
                                                </div>
                                            </div>
                                        </template>
                                        <p x-show="filteredCaptives.length === 0" class="text-center text-gray-400">地牢中沒有任何俘虜，或篩選結果為空。</p>
                                    </div>
                                </div>
                                <div x-show="modals.dungeon.subTab === 'breed'">
                                    <h3 class="text-xl font-bold mb-2">繁衍後代</h3>
                                    <p class="mb-4">選擇要繁衍的對象。每日剩餘次數: <span x-text="breedingChargesLeft"></span> / <span x-text="totalBreedingCharges"></span></p>
                                    <div class="space-y-2">
                                        <template x-for="captive in dungeonCaptives" :key="captive.id">
                                            <label class="p-3 border border-gray-600 rounded block cursor-pointer hover:bg-gray-700 transition-colors">
                                                <div class="flex justify-between items-start">
                                                    <div class="flex-grow">
                                                        <p class="font-bold text-amber-200"><span x-text="captive.name"></span> (<span x-text="captive.profession"></span>)</p>
                                                        <p class="text-sm">
                                                            <span class="text-pink-400">魅力: <span x-text="captive.stats.charisma"></span></span>
                                                            <span class="text-gray-400" x-text="` | 繁衍: ${(captive.breedingCount || 0)} 次`"></span>
                                                        </p> 
                                                        <template x-if="captive.visual">
                                                            <div class="mt-2 pt-2 border-t border-gray-700 text-xs text-gray-400 grid grid-cols-2 gap-x-3 gap-y-1">
                                                                <span>身高: <span x-text="captive.visual.height + ' cm'"></span></span>
                                                                <span>胸圍: <span x-text="captive.visual.bust"></span></span>
                                                                <span>髮色: <span x-text="captive.visual.hairColor"></span></span>
                                                                <span>髮型: <span x-text="captive.visual.hairStyle"></span></span>
                                                                <template x-if="captive.race === 'elf'">
                                                                    <span>耳朵: <span x-text="captive.visual.elfEars"></span></span>
                                                                </template>
                                                                <template x-if="captive.race === 'beastkin'">
                                                                    <span>亞種: <span x-text="captive.visual.beastkinSubspecies"></span></span>
                                                                </template>
                                                                <span>個性: <span x-text="captive.visual.personality"></span></span>
                                                            </div>
                                                        </template>
                                                    </div>
                                                    <div class="flex-shrink-0 ml-4">
                                                        <input type="checkbox" :value="captive.id" x-model="modals.dungeon.selectedBreedIds" @click.stop class="form-checkbox h-5 w-5 bg-gray-800 border-gray-500 text-green-500 focus:ring-green-500">
                                                    </div>
                                                </div>
                                            </label>
                                        </template>
                                        <p x-show="dungeonCaptives.length === 0" class="text-center text-gray-400">沒有可繁衍的對象。</p>
                                    </div>
                                    <div class="text-center mt-4">
                                        <button @click="handleBreedingClick()"
                                                :disabled="canExecuteBreeding"
                                                class="btn btn-primary">
                                            執行繁衍 (<span x-text="modals.dungeon.selectedBreedIds.length"></span>)
                                        </button>
                                        <p x-show="captives.length >= captiveCapacity" class="text-red-400 text-sm mt-2">地牢空間已滿！</p>
                                    </div>
                                </div>
                                <div x-show="modals.dungeon.subTab === 'upgrade'">
                                    <h3 class="text-xl font-bold mb-2">升級地牢 (等級 <span x-text="buildings.dungeon.level"></span>)</h3>
                                    <p class="text-sm text-gray-400 mb-4">增加俘虜容量上限。</p>
                                    
                                    <template x-if="buildings.dungeon.level < 5">
                                        <div>
                                            <p class="text-sm">
                                                <span x-text="buildings.dungeon.level === 0 ? '建造花費:' : `升級至 ${buildings.dungeon.level + 1} 級花費:`"></span>
                                                <span x-text="getBuildingUpgradeCost('dungeon').food"></span> 食物,
                                                <span x-text="getBuildingUpgradeCost('dungeon').wood"></span> 木材,
                                                <span x-text="getBuildingUpgradeCost('dungeon').stone"></span> 礦石
                                            </p>
                                            <button @click="upgradeBuilding('dungeon')" class="btn btn-primary mt-2" :disabled="!canAffordBuildingUpgrade('dungeon')" >
                                                <span x-text="buildings.dungeon.level === 0 ? '建造' : '升級'"></span>
                                            </button>
                                        </div>
                                    </template>
                                    
                                    <p x-show="buildings.dungeon.level >= 5" class="text-sm text-green-400 mt-2">地牢已達到最大等級！</p>
                                </div>
                            </div>
                            <div x-show="modals.construction.activeTab === 'barracks'">
                                <div class="flex border-b border-gray-600 mb-4">
                                    <button @click="modals.barracks.subTab = 'manage'" :class="{ 'bg-gray-700 text-white': modals.barracks.subTab === 'manage' }" class="flex-1 py-2 px-4 rounded-t-lg text-sm">管理夥伴</button>
                                    <button @click="modals.barracks.subTab = 'upgrade'" :class="{ 'bg-gray-700 text-white': modals.barracks.subTab === 'upgrade' }" class="flex-1 py-2 px-4 rounded-t-lg text-sm">升級</button>
                                </div>
                                <div x-show="modals.barracks.subTab === 'manage'">
                                    <h3 class="text-xl font-bold mb-2">管理夥伴</h3>
                                    <p class="mb-2">選擇最多 20 名夥伴加入你的出擊隊伍。</p>
                                    <p class="mb-4">目前夥伴: <span x-text="partners.length"></span> / <span x-text="partnerCapacity"></span> | 當前隊伍: <span x-text="player?.party.length || 0"></span> / 20</p>
                                    
                                    <div class="space-y-2 max-h-96 overflow-y-auto pr-2 border border-gray-700 rounded p-2">
                                        <template x-for="p in availablePartnersForParty" :key="p.id">
                                            <div class="p-2 border border-gray-600 rounded">
                                                <label class="flex justify-between items-center cursor-pointer hover:bg-gray-700 p-1 rounded-t">
                                                    <div>
                                                        <p class="font-bold text-amber-200" x-text="p.name"></p>
                                                        <div class="text-xs text-gray-400 grid grid-cols-2 gap-x-4">
                                                            <span>力: <span x-text="p.stats.strength"></span><span class="text-blue-400" x-text="formatBonus(p.getTotalStat('strength', isStarving) - p.stats.strength)"></span></span>
                                                            <span>敏: <span x-text="p.stats.agility"></span><span class="text-blue-400" x-text="formatBonus(p.getTotalStat('agility', isStarving) - p.stats.agility)"></span></span>
                                                            <span>智: <span x-text="p.stats.intelligence"></span><span class="text-blue-400" x-text="formatBonus(p.getTotalStat('intelligence', isStarving) - p.stats.intelligence)"></span></span>
                                                            <span>運: <span x-text="p.stats.luck"></span><span class="text-blue-400" x-text="formatBonus(p.getTotalStat('luck', isStarving) - p.stats.luck)"></span></span>
                                                        </div>
                                                        <p class="text-xs text-gray-400 mt-1">
                                                            <span>HP:</span>
                                                            <span x-text="p.currentHp"></span> / <span x-text="p.getBaseMaxHp(isStarving)"></span>
                                                            <span class="text-blue-400" x-show="p.calculateMaxHp(isStarving) - p.getBaseMaxHp(isStarving) !== 0" x-text="`( +${p.calculateMaxHp(isStarving) - p.getBaseMaxHp(isStarving)})`"></span>
                                                        </p>
                                                        <div class="mt-2 pt-2 border-t border-gray-600 space-y-1 text-xs">
                                                            <p class="font-bold text-amber-200">裝備:</p>
                                                            <template x-for="slot in Object.keys(p.equipment)" :key="slot">
                                                                <div class="pl-2">
                                                                    <span class="capitalize" x-text="EQUIPMENT_SLOTS[slot] || slot"></span>:
                                                                    <span x-show="p.equipment[slot]" :style="{ color: p.equipment[slot]?.quality.color }" x-text="p.equipment[slot]?.name"></span>
                                                                    <span x-show="!p.equipment[slot]" class="text-gray-500">-- 無 --</span>
                                                                </div>
                                                            </template>
                                                        </div>
                                                    </div>
                                                    <input type="checkbox" :value="p.id" x-model="modals.barracks.selectedPartyIds" class="form-checkbox h-5 w-5 bg-gray-800 border-gray-500 text-green-500 focus:ring-green-500" :disabled="!modals.barracks.selectedPartyIds.includes(p.id) && modals.barracks.selectedPartyIds.length >= 20">
                                                </label>
                                                <div class="text-right pt-2 border-t border-gray-700">
                                                    <button @click="openPartnerEquipment(p.id)" class="btn btn-secondary btn-sm">管理裝備</button>
                                                    <button @click="releasePartner(p.id)" class="btn btn-danger btn-sm">逐出部落</button>
                                                </div>
                                            </div>
                                        </template>
                                        <p x-show="partners.length === 0" class="text-center text-gray-400">沒有任何夥伴。</p>
                                    </div>
                                    <div class="text-center mt-4">
                                        <button @click="confirmPartySelection()" class="btn btn-primary">確認隊伍</button>
                                    </div>
                                </div>
                                <div x-show="modals.barracks.subTab === 'upgrade'">
                                    <h3 class="text-xl font-bold mb-2">升級寢室 (等級 <span x-text="buildings.barracks.level"></span>)</h3>
                                    <p class="text-sm text-gray-400 mb-4">增加哥布林夥伴數量上限。</p>
                                    <template x-if="buildings.barracks.level < 5">
                                        <div>
                                            <p class="text-sm">
                                                <span x-text="buildings.barracks.level === 0 ? '建造花費:' : `升級至 ${buildings.barracks.level + 1} 級花費:`"></span>
                                                
                                                <span x-show="getBuildingUpgradeCost('barracks').food > 0">
                                                    <span x-text="getBuildingUpgradeCost('barracks').food"></span> 食物, 
                                                </span>
                                                
                                                <span x-text="getBuildingUpgradeCost('barracks').wood"></span> 木材,
                                                <span x-text="getBuildingUpgradeCost('barracks').stone"></span> 礦石
                                            </p>
                                            <button @click="upgradeBuilding('barracks')" class="btn btn-primary mt-2" :disabled="!canAffordBuildingUpgrade('barracks')">
                                                <span x-text="buildings.barracks.level === 0 ? '建造' : '升級'"></span>
                                            </button>
                                        </div>
                                    </template>
                                    <p x-show="buildings.barracks.level >= 5" class="text-sm text-green-400 mt-2">寢室已達到最大等級！</p>
                                </div>
                            </div>
                            <div x-show="modals.construction.activeTab === 'warehouse'">
                                <div class="flex border-b border-gray-600 mb-4">
                                    <button @click="modals.warehouse.subTab = 'manage'" :class="{ 'bg-gray-700 text-white': modals.warehouse.subTab === 'manage' }" class="flex-1 py-2 px-4 rounded-t-lg text-sm">裝備管理</button>
                                    <button @click="modals.warehouse.subTab = 'upgrade'" :class="{ 'bg-gray-700 text-white': modals.warehouse.subTab === 'upgrade' }" class="flex-1 py-2 px-4 rounded-t-lg text-sm">升級</button>
                                </div>
                                <div x-show="modals.warehouse.subTab === 'manage'">
                                    <div class="flex items-center space-x-2 mb-4 border-b border-gray-600 pb-3">
                                        <span class="font-bold text-sm text-gray-400">篩選類型:</span>
                                        <button @click="modals.warehouse.activeFilter = 'all'" class="btn btn-xs" :class="{ 'btn-primary': modals.warehouse.activeFilter === 'all', 'btn-secondary': modals.warehouse.activeFilter !== 'all' }">全部</button>
                                        <button @click="modals.warehouse.activeFilter = 'weapon'" class="btn btn-xs" :class="{ 'btn-primary': modals.warehouse.activeFilter === 'weapon', 'btn-secondary': modals.warehouse.activeFilter !== 'weapon' }">武器</button>
                                        <button @click="modals.warehouse.activeFilter = 'shield'" class="btn btn-xs" :class="{ 'btn-primary': modals.warehouse.activeFilter === 'shield', 'btn-secondary': modals.warehouse.activeFilter !== 'shield' }">盾牌</button>
                                        <button @click="modals.warehouse.activeFilter = 'armor'" class="btn btn-xs" :class="{ 'btn-primary': modals.warehouse.activeFilter === 'armor', 'btn-secondary': modals.warehouse.activeFilter !== 'armor' }">鎧甲</button>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold mb-2">部落倉庫 (<span x-text="filteredWarehouseInventory.length"></span> / <span x-text="warehouseCapacity"></span>)</h3>
                                        <div class="space-y-2 max-h-48 overflow-y-auto p-1 border border-gray-700 rounded mb-4">
                                            <template x-for="item in filteredWarehouseInventory" :key="item.id">
                                                <div class="p-3 border border-gray-600 rounded flex flex-col">
                                                    <div class="w-full mb-2">
                                                        <p :style="{ color: item.quality.color }" x-text="item.name"></p>
                                                        <p class="text-xs text-gray-400" x-html="getItemStatsString(item)"></p>
                                                    </div>
                                                    <div class="w-full flex space-x-2">
                                                        <button @click="moveToBackpack(item.id)" class="btn btn-sm btn-secondary flex-grow">移至背包</button>
                                                        <button @click="decomposeItem(item.id)" class="btn btn-sm btn-danger flex-grow" :disabled="buildings.armory.level === 0" title="需要先建造兵工廠">分解</button>
                                                        <button @click="openDiscardConfirm(item.id)" class="btn btn-sm btn-secondary flex-grow">丟棄</button>
                                                    </div>
                                                </div>
                                            </template>
                                            <p x-show="filteredWarehouseInventory.length === 0" class="text-center text-gray-400">你的倉庫是空的，或篩選結果為空。</p>
                                        </div>
                                    </div>
                                    <div>
                                        <h3 class="text-xl font-bold mb-2">玩家背包 (<span x-text="filteredPlayerInventory.length"></span> / <span x-text="backpackCapacity"></span>)</h3>
                                        <div class="space-y-2 max-h-48 overflow-y-auto p-1 border border-gray-700 rounded">
                                            <template x-for="item in filteredPlayerInventory" :key="item.id">
                                                <div class="p-3 border border-gray-600 rounded flex flex-col">
                                                    <div class="w-full mb-2">
                                                        <p :style="{ color: item.quality.color }" x-text="item.name"></p>
                                                        <p class="text-xs text-gray-400" x-html="getItemStatsString(item)"></p>
                                                    </div>
                                                    <div class="w-full flex space-x-2">
                                                        <button @click="moveToWarehouse(item.id)" class="btn btn-sm btn-secondary flex-grow">移至倉庫</button>
                                                        <button @click="decomposeItem(item.id)" class="btn btn-sm btn-danger flex-grow" :disabled="buildings.armory.level === 0" title="需要先建造兵工廠">分解</button>
                                                        <button @click="openDiscardConfirm(item.id)" class="btn btn-sm btn-secondary flex-grow">丟棄</button>
                                                    </div>
                                                </div>
                                            </template>
                                            <p x-show="filteredPlayerInventory.length === 0" class="text-center text-gray-400">你的背包是空的，或篩選結果為空。</p>
                                        </div>
                                    </div>
                                </div>
                                <div x-show="modals.warehouse.subTab === 'upgrade'">
                                    <h3 class="text-xl font-bold mb-2">升級倉庫 (等級 <span x-text="buildings.warehouse.level"></span>)</h3>
                                    <p class="text-sm text-gray-400 mb-4">增加倉庫和背包的儲存上限。</p>
                                    <p class="mb-4">當前容量: 倉庫 <span x-text="warehouseCapacity"></span> / 背包 <span x-text="backpackCapacity"></span></p>
                                    <template x-if="buildings.warehouse.level < 6">
                                        <div>
                                            <p class="text-sm">
                                                <span x-text="buildings.warehouse.level === 0 ? '建造花費:' : `升級至 ${buildings.warehouse.level + 1} 級花費:`"></span>
                                                <span x-text="getBuildingUpgradeCost('warehouse').wood"></span> 木材,
                                                <span x-text="getBuildingUpgradeCost('warehouse').stone"></span> 礦石
                                            </p>
                                            <button @click="upgradeBuilding('warehouse')" class="btn btn-primary mt-2" :disabled="!canAffordBuildingUpgrade('warehouse')">
                                                <span x-text="buildings.warehouse.level === 0 ? '建造' : '升級'"></span>
                                            </button>
                                        </div>
                                    </template>
                                    <p x-show="buildings.warehouse.level >= 6" class="text-sm text-green-400 mt-2">倉庫已達到最大等級！</p>
                                </div>
                            </div>

                            <div x-show="modals.construction.activeTab === 'armory'">
                                <div class="flex border-b border-gray-600 mb-4">
                                    <button @click="modals.armory.subTab = 'craft'" :class="{ 'bg-gray-700 text-white': modals.armory.subTab === 'craft' }" class="flex-1 py-2 px-4 rounded-t-lg text-sm">製作</button>
                                    <button @click="modals.armory.subTab = 'upgrade'" :class="{ 'bg-gray-700 text-white': modals.armory.subTab === 'upgrade' }" class="flex-1 py-2 px-4 rounded-t-lg text-sm">升級</button>
                                </div>
                                <div x-show="modals.armory.subTab === 'craft'">
                                    <h3 class="text-xl font-bold mb-2">製作裝備</h3>
                                    <div class="space-y-4">
                                        <div>
                                            <label>類型:</label>
                                            <select x-model="modals.armory.craftingType" class="bg-gray-700 border-2 border-gray-600 rounded px-3 py-2 w-full">
                                                <template x-for="type in craftableTypes.filter(t => !t.requires || dlc[t.requires])" :key="type.baseName">
                                                    <option :value="type.baseName" x-text="type.baseName"></option>
                                                </template>
                                            </select>
                                        </div>
                                        <div>
                                            <label>階級:</label>
                                            <select x-model.number="modals.armory.craftingTier" class="bg-gray-700 border-2 border-gray-600 rounded px-3 py-2 w-full">
                                                <template x-for="option in availableCraftingOptions" :key="option.tier">
                                                    <option :value="option.tier" x-text="`${option.name} (第 ${option.tier} 階)`"></option>
                                                </template>
                                            </select>
                                        </div>
                                        <div x-show="modals.armory.craftingTier > 0">
                                            <p>
                                                花費: 
                                                <span class="text-green-400">食物 <span x-text="getCraftingCost().food"></span></span>, 
                                                <span class="text-yellow-500">木材 <span x-text="getCraftingCost().wood"></span></span>, 
                                                <span class="text-gray-400">礦石 <span x-text="getCraftingCost().stone"></span></span>
                                            </p>
                                        </div>
                                        <button @click="craftItem()" class="btn btn-primary w-full" :disabled="!canAffordCraft">製作</button>
                                    </div>
                                </div>
                                <div x-show="modals.armory.subTab === 'upgrade'">
                                    <h3 class="text-xl font-bold mb-2">升級兵工廠 (等級 <span x-text="buildings.armory.level"></span>)</h3>
                                    <p class="text-sm text-gray-400 mb-4">解鎖可製作的材質等級，並提升裝備分解的資源返還率。</p>
                                    <template x-if="buildings.armory.level < 4">
                                        <div>
                                            <p class="text-sm">
                                                <span x-text="buildings.armory.level === 0 ? '建造花費:' : `升級至 ${buildings.armory.level + 1} 級花費:`"></span>
                                                <span x-text="getBuildingUpgradeCost('armory').wood"></span> 木材,
                                                <span x-text="getBuildingUpgradeCost('armory').stone"></span> 礦石
                                            </p>
                                            <p class="text-sm mt-1">下一級分解返還率: <span x-text="['20%', '30%', '40%', '50%'][buildings.armory.level]"></span></p>
                                            <button @click="upgradeBuilding('armory')" class="btn btn-primary mt-2" :disabled="!canAffordBuildingUpgrade('armory')">
                                                <span x-text="buildings.armory.level === 0 ? '建造' : '升級'"></span>
                                            </button>
                                        </div>
                                    </template>
                                    <p x-show="buildings.armory.level >= 4" class="text-sm text-green-400 mt-2">兵工廠已達到最大等級！</p>
                                </div>
                            </div>

                            <div x-show="modals.construction.activeTab === 'trainingGround'">
                                <template x-if="buildings.trainingGround.level === 0">
                                    <div>  <h3 class="text-xl font-bold mb-2">建造訓練場</h3>
                                        <p class="text-sm text-gray-400 mb-4">建造一個設施來訓練你的哥布林夥伴，讓他們變得更強。</p>
                                        <div>
                                            <p class="text-sm">
                                                <span>建造成本:</span>
                                                <span x-text="getBuildingUpgradeCost('trainingGround').food"></span> 食物,
                                                <span x-text="getBuildingUpgradeCost('trainingGround').wood"></span> 木材,
                                                <span x-text="getBuildingUpgradeCost('trainingGround').stone"></span> 礦石
                                            </p>
                                            <button @click="upgradeBuilding('trainingGround')" class="btn btn-primary mt-2" :disabled="!canAffordBuildingUpgrade('trainingGround')">
                                                <span>建造</span>
                                            </button>
                                        </div>
                                    </div>
                                </template>

                                <template x-if="buildings.trainingGround.level > 0">
                                    <div>
                                        <h3 class="text-xl font-bold mb-2">夥伴訓練</h3>
                                        <p class="mb-4 text-sm text-gray-400">選擇一名夥伴進行一對一訓練，將消耗一天時間。訓練將參考您<span class="text-yellow-400">自身原始能力</span>，為夥伴增加 <span class="font-bold text-green-400" x-text="potentialTrainingPoints"></span> 點隨機屬性。每位夥伴一生只能接受一次訓練。</p>
                                        
                                        <div class="space-y-4 max-h-96 overflow-y-auto pr-2 border border-gray-700 rounded p-2">
                                            <template x-for="p in partners" :key="p.id">
                                                <div class="p-3 border border-gray-600 rounded flex justify-between items-center">
                                                    <div>
                                                        <p class="text-lg font-bold text-amber-200" x-text="p.name"></p>
                                                        <p class="text-xs text-gray-400">力:<span x-text="p.stats.strength"></span> 敏:<span x-text="p.stats.agility"></span> 智:<span x-text="p.stats.intelligence"></span> 運:<span x-text="p.stats.luck"></span></p>
                                                    </div>
                                                    <button @click="executeTraining(p.id)" class="btn btn-sm btn-primary" :disabled="p.hasBeenTrained">
                                                        <span x-text="p.hasBeenTrained ? '已訓練' : '訓練'"></span>
                                                    </button>
                                                </div>
                                            </template>
                                            <p x-show="partners.length === 0" class="text-center text-gray-400">你沒有任何夥伴可以訓練。</p>
                                        </div>
                                    </div>
                                </template>
                            </div>

                            <div x-show="modals.construction.activeTab === 'watchtower'">
                                <div class="flex border-b border-gray-600 mb-4">
                                    <button @click="modals.dungeon.subTab = 'manage'" :class="{ 'bg-gray-700 text-white': modals.dungeon.subTab === 'manage' }" class="flex-1 py-2 px-4 rounded-t-lg text-sm">派駐夥伴</button>
                                    <button @click="modals.dungeon.subTab = 'upgrade'" :class="{ 'bg-gray-700 text-white': modals.dungeon.subTab === 'upgrade' }" class="flex-1 py-2 px-4 rounded-t-lg text-sm">升級</button>
                                </div>

                                <div x-show="modals.dungeon.subTab === 'manage'">
                                    <h3 class="text-xl font-bold mb-2">派駐夥伴</h3>
                                    <p class="mb-4">將夥伴派駐到哨塔以降低復仇小隊來襲的機率。目前效果：<strong class="text-green-400" x-text="`- ${dispatch.watchtower.length * [0, 2, 4, 6, 8, 10][buildings.watchtower.level]}%`"></strong></p>
                                    <div class="grid grid-cols-2 gap-6">
                                        <div>
                                            <h3 class="text-lg font-bold mb-2 text-amber-200">可派駐的哥布林</h3>
                                            <div class="space-y-2 h-96 overflow-y-auto pr-2 border border-gray-700 rounded p-2">
                                                <template x-for="p in availablePartnersForDispatch" :key="p.id">
                                                    <div class="p-3 border border-gray-600 rounded flex justify-between items-center">
                                                        <div>
                                                            <p class="font-bold" x-text="p.name"></p>
                                                            <p class="text-xs text-gray-400">力:<span x-text="p.stats.strength"></span> 敏:<span x-text="p.stats.agility"></span> 智:<span x-text="p.stats.intelligence"></span> 運:<span x-text="p.stats.luck"></span></p>
                                                        </div>
                                                        <button @click="assignPartner(p.id, 'watchtower')" class="btn btn-sm btn-success">派駐</button>
                                                    </div>
                                                </template>
                                                <p x-show="availablePartnersForDispatch.length === 0" class="text-center text-gray-400">沒有可派駐的夥伴了。</p>
                                            </div>
                                        </div>
                                        <div>
                                            <h3 class="text-lg font-bold mb-2 text-amber-200">
                                                已派駐的守衛 (<span x-text="dispatch.watchtower.length"></span> / 5)
                                            </h3>
                                            <div class="space-y-2 h-96 overflow-y-auto pr-2 border border-gray-700 rounded p-2">
                                                <template x-for="p in getDispatchedPartners('watchtower')" :key="p.id">
                                                    <div class="p-3 border border-gray-600 rounded flex justify-between items-center">
                                                        <div>
                                                            <p class="font-bold" x-text="p.name"></p>
                                                            <p class="text-xs text-gray-400">力:<span x-text="p.stats.strength"></span> 敏:<span x-text="p.stats.agility"></span> 智:<span x-text="p.stats.intelligence"></span> 運:<span x-text="p.stats.luck"></span></p>
                                                        </div>
                                                        <button @click="removeFromDispatch(p.id, 'watchtower')" class="btn btn-sm btn-danger">解除</button>
                                                    </div>
                                                </template>
                                                <p x-show="dispatch.watchtower.length === 0" class="text-center text-gray-400">尚未派駐任何守衛。</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div x-show="modals.dungeon.subTab === 'upgrade'">
                                    <h3 class="text-xl font-bold mb-2">升級哨塔 (等級 <span x-text="buildings.watchtower.level"></span>)</h3>
                                    <p class="text-sm text-gray-400 mb-4">提升每位守衛能降低的復仇機率。</p>
                                    <p class="mb-4">目前效果: 每位守衛 <strong class="text-green-400" x-text="`- ${[0, 2, 4, 6, 8, 10][buildings.watchtower.level]}%`"></strong></p>
                                    <template x-if="buildings.watchtower.level < 5">
                                        <div>
                                            <p class="text-sm">
                                                <span x-text="buildings.watchtower.level === 0 ? '建造花費:' : `升級至 ${buildings.watchtower.level + 1} 級花費:`"></span>
                                                <span x-text="getBuildingUpgradeCost('watchtower').food"></span> 食物,
                                                <span x-text="getBuildingUpgradeCost('watchtower').wood"></span> 木材,
                                                <span x-text="getBuildingUpgradeCost('watchtower').stone"></span> 礦石
                                            </p>
                                            <p class="text-sm mt-1">下一級效果: 每位守衛 <strong class="text-green-400" x-text="`- ${[0, 2, 4, 6, 8, 10][buildings.watchtower.level + 1]}%`"></strong></p>
                                            <button @click="upgradeBuilding('watchtower')" class="btn btn-primary mt-2" :disabled="!canAffordBuildingUpgrade('watchtower')">
                                                <span x-text="buildings.watchtower.level === 0 ? '建造' : '升級'"></span>
                                            </button>
                                        </div>
                                    </template>
                                    <p x-show="buildings.watchtower.level >= 5" class="text-sm text-green-400 mt-2">哨塔已達到最大等級！</p>
                                </div>
                            </div>

                            <div x-show="modals.construction.activeTab === 'merchantCamp'">
                                <h3 class="text-xl font-bold mb-2">升級商人營地 (等級 <span x-text="buildings.merchantCamp.level"></span>)</h3>
                                <p class="text-sm text-gray-400 mb-4">提升旅行商人販售的商品數量，並增加其停留時間。</p>
                                <template x-if="buildings.merchantCamp.level < 4">
                                    <div>
                                        <p class="text-sm">
                                            <span x-text="buildings.merchantCamp.level === 0 ? '建造花費:' : `升級至 ${buildings.merchantCamp.level + 1} 級花費:`"></span>
                                            <span x-text="getBuildingUpgradeCost('merchantCamp').food"></span> 食物,
                                            <span x-text="getBuildingUpgradeCost('merchantCamp').wood"></span> 木材,
                                            <span x-text="getBuildingUpgradeCost('merchantCamp').stone"></span> 礦石
                                        </p>
                                        <p class="text-sm mt-1">下一級商品數量: <span x-text="[2, 4, 6, 8, 10][buildings.merchantCamp.level]"></span> -> <span class="text-green-400" x-text="[4, 6, 8, 10][buildings.merchantCamp.level]"></span></p>
                                        <p class="text-sm mt-1">下一級停留時間: <span x-text="1 + buildings.merchantCamp.level"></span> 天 -> <span class="text-green-400" x-text="2 + buildings.merchantCamp.level"></span> 天</p>
                                        <button @click="upgradeBuilding('merchantCamp')" class="btn btn-primary mt-2" :disabled="!canAffordBuildingUpgrade('merchantCamp')">
                                            <span x-text="buildings.merchantCamp.level === 0 ? '建造' : '升級'"></span>
                                        </button>
                                    </div>
                                </template>
                                <p x-show="buildings.merchantCamp.level >= 4" class="text-sm text-green-400 mt-2">商人營地已達到最大等級！</p>
                            </div>

                            <div class="text-right mt-6">
                                <button @click="modals.construction.isOpen = false" class="btn btn-secondary">關閉</button>
                            </div>
                        </div>
                    </div>
                </div>  

                <!-- 偵查目標 Modal -->
                <div class="modal" x-show="modals.scoutInfo.isOpen" x-cloak>
                    <template x-if="modals.scoutInfo.target">
                        <div class="modal-content game-container relative p-6 rounded-lg">
                            <h2 class="game-title font-medieval">偵查情報</h2>

                            <div class="pt-10 max-h-[70vh] overflow-y-auto">
                                <template x-if="modals.scoutInfo.target.length > 0">
                                    <div class="space-y-4">
                                        <template x-for="unit in modals.scoutInfo.target" :key="unit.id">
                                            <div class="p-3 border border-gray-700 rounded">
                                                <p class="text-lg font-bold text-amber-200"><span x-text="unit.name"></span> - <span x-text="unit.profession"></span></p>
                                                <p><strong>生命值:</strong> <span x-text="unit.currentHp"></span> / <span x-text="unit.getBaseMaxHp()"></span><span class="text-blue-400" x-text="formatBonus(unit.calculateMaxHp() - unit.getBaseMaxHp())"></span></p>
                                                <div class="mt-2 pt-2 border-t border-gray-600 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                                    <span>力量: <span x-text="unit.stats.strength"></span><span class="text-xs text-blue-400" x-text="formatBonus(unit.getTotalStat('strength') - unit.stats.strength)"></span></span>
                                                    <span>敏捷: <span x-text="unit.stats.agility"></span><span class="text-xs text-blue-400" x-text="formatBonus(unit.getTotalStat('agility') - unit.stats.agility)"></span></span>
                                                    <span>智力: <span x-text="unit.stats.intelligence"></span><span class="text-xs text-blue-400" x-text="formatBonus(unit.getTotalStat('intelligence') - unit.stats.intelligence)"></span></span>
                                                    <span>運氣: <span x-text="unit.stats.luck"></span><span class="text-xs text-blue-400" x-text="formatBonus(unit.getTotalStat('luck') - unit.stats.luck)"></span></span>
                                                    <div class="col-span-2" x-show="unit.stats.charisma > 0"><strong>魅力:</strong> <span x-text="unit.stats.charisma"></span></div>
                                                </div>
                                                <div class="mt-2 pt-2 border-t border-gray-600 text-sm">
                                                    <p class="font-bold text-amber-200">裝備:</p>
                                                    <div class="space-y-1 pl-2">
                                                        <template x-for="slot in Object.keys(unit.equipment || {})" :key="slot">
                                                            <div>
                                                                <span class="capitalize" x-text="EQUIPMENT_SLOTS[slot] || slot"></span>:
                                                                <template x-if="unit.equipment[slot]">
                                                                    <span :style="{ color: unit.equipment[slot].quality.color }" x-text="unit.equipment[slot].name"></span>
                                                                </template>
                                                                <template x-if="!unit.equipment[slot]">
                                                                    <span class="text-gray-500">-- 無 --</span>
                                                                </template>
                                                            </div>
                                                        </template>
                                                    </div>
                                                </div>
                                                <template x-if="unit.visual">
                                                    <div class="mt-2 pt-2 border-t border-gray-600 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                                        <div><strong>身高:</strong> <span x-text="unit.visual.height"></span> cm</div>
                                                        <div><strong>年紀:</strong> <span x-text="unit.visual.age"></span></div>
                                                        <div><strong>髮色:</strong> <span x-text="unit.visual.hairColor"></span></div>
                                                        <div><strong>髮型:</strong> <span x-text="unit.visual.hairStyle"></span></div>
                                                        <div><strong>服裝:</strong> <span x-text="unit.visual.clothing"></span></div>
                                                        <div><strong>胸圍:</strong> <span x-text="unit.visual.bust"></span></div>
                                                        <template x-if="unit.race === 'elf'">
                                                            <div><strong>耳朵:</strong> <span x-text="unit.visual.elfEars"></span></div>
                                                        </template>
                                                        <template x-if="unit.race === 'beastkin'">
                                                            <div><strong>亞種:</strong> <span x-text="unit.visual.beastkinSubspecies"></span></div>
                                                        </template>
                                                        <div><strong>個性:</strong> <span x-text="unit.visual.personality"></span></div>
                                                    </div>
                                                </template>
                                            </div>
                                        </template>
                                    </div>
                                </template>

                                <template x-if="modals.scoutInfo.target.length === 0">
                                    <p class="text-center text-lg py-8" x-text="modals.scoutInfo.emptyBuildingMessage"></p>
                                </template>
                            </div>

                            <div class="text-right mt-6 pt-4 border-t border-gray-600 space-x-2">
                                <template x-if="!modals.scoutInfo.isCombatView">
                                    <span>
                                        <template x-if="Array.isArray(modals.scoutInfo.target) && modals.scoutInfo.target.length > 0 && selectedTarget && !selectedTarget.isFinalChallenge">
                                            <button @click="startCombatFromScout(modals.scoutInfo.target)" class="btn btn-danger">攻擊</button>
                                        </template>

                                        <template x-if="Array.isArray(modals.scoutInfo.target) && modals.scoutInfo.target.some(e => e.visual) && selectedTarget && !selectedTarget.isFinalChallenge">
                                            <button @click="executeSneakKidnapFromModal()" class="btn btn-secondary">潛行擄走</button>
                                        </template>

                                        <template x-if="Array.isArray(modals.scoutInfo.target) && modals.scoutInfo.target.length === 0 && selectedTarget && !Array.isArray(selectedTarget) && !selectedTarget.looted">
                                            <button @click="lootBuildingFromModal()" class="btn btn-primary">搜刮建築</button>
                                        </template>
                                    </span>
                                </template>

                                <button @click.stop="closeScoutModalAndClearTarget()" class="btn btn-secondary">關閉</button>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- 掠奪俘虜管理 Modal -->
                <div class="modal" x-show="modals.raidCaptives.isOpen" x-cloak>
                    <div class="modal-content game-container relative p-6 rounded-lg">
                        <h2 class="game-title font-medieval">管理本次俘虜</h2>
                        <div class="pt-10 max-h-[80vh] overflow-y-auto">

                            <p class="mb-4 text-center">
                                <span>攜帶俘虜: </span>
                                <span class="font-bold" x-text="currentRaid?.carriedCaptives.length ?? 0"></span> /
                                <span class="font-bold" x-text="carryCapacity"></span>
                            </p>

                            <div class="space-y-4">
                                <template x-for="captive in currentRaid?.carriedCaptives || []" :key="captive.id">
                                    <div class="p-3 border border-gray-600 rounded">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="text-lg font-bold text-amber-200">
                                                    <span x-text="captive.name"></span> - <span x-text="captive.profession"></span>
                                                </p>
                                            </div>
                                            <div class="text-right text-sm">
                                                <p>魅力: <span class="font-bold text-pink-400" x-text="captive.stats.charisma"></span></p>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-2 pt-2 border-t border-gray-700 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                            <div><strong>力量:</strong> <span x-text="captive.stats.strength"></span></div>
                                            <div><strong>敏捷:</strong> <span x-text="captive.stats.agility"></span></div>
                                            <div><strong>智力:</strong> <span x-text="captive.stats.intelligence"></span></div>
                                            <div><strong>運氣:</strong> <span x-text="captive.stats.luck"></span></div>
                                        </div>

                                        <template x-if="captive.visual">
                                            <div class="mt-2 pt-2 border-t border-gray-700 grid grid-cols-2 gap-x-4 gap-y-1 text-sm text-gray-400">
                                                <div><strong>身高:</strong> <span x-text="captive.visual.height + ' cm'"></span></div>
                                                <div><strong>年紀:</strong> <span x-text="captive.visual.age"></span></div>
                                                <div><strong>髮色:</strong> <span x-text="captive.visual.hairColor"></span></div>
                                                <div><strong>髮型:</strong> <span x-text="captive.visual.hairStyle"></span></div>
                                                <div><strong>服裝:</strong> <span x-text="captive.visual.clothing"></span></div>
                                                <div><strong>胸圍:</strong> <span x-text="captive.visual.bust"></span></div>
                                                <template x-if="captive.race === 'elf'">
                                                    <div><strong>耳朵:</strong> <span x-text="captive.visual.elfEars"></span></div>
                                                </template>
                                                <template x-if="captive.race === 'beastkin'">
                                                    <div><strong>亞種:</strong> <span x-text="captive.visual.beastkinSubspecies"></span></div>
                                                </template>
                                                <div><strong>個性:</strong> <span x-text="captive.visual.personality"></span></div>
                                            </div>
                                        </template>
                                        
                                        <div class="text-right mt-2">
                                            <button @click="releaseCarriedCaptive(captive.id)" class="btn btn-danger btn-sm">釋放</button>
                                        </div>
                                    </div>
                                </template>
                                <p x-show="!currentRaid || currentRaid.carriedCaptives.length === 0" class="text-center text-gray-400">你尚未捕獲任何俘虜。</p>
                            </div>
                            <div class="text-right mt-6">
                                <button @click="modals.raidCaptives.isOpen = false" class="btn btn-secondary">關閉</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 統一俘虜管理 Modal -->
                <div class="modal" x-show="modals.captiveManagement.isOpen" x-cloak>
                    <div class="modal-content game-container relative p-6 rounded-lg">
                        <h2 class="game-title font-medieval" x-text="modals.captiveManagement.title"></h2>
                        <div class="pt-10 max-h-[80vh] overflow-y-auto">
                            <p class="mb-4">請選擇要保留的俘虜。上限: <span x-text="modals.captiveManagement.selectedIds.length"></span> /
                                <span x-text="modals.captiveManagement.limit"></span>
                            </p>
                            <div class="space-y-4">
                                <template x-for="captive in modals.captiveManagement.list" :key="captive.id">
                                    <div class="p-3 border border-gray-600 rounded">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="text-lg font-bold text-amber-200"><span x-text="captive.name"></span> -
                                                    <span x-text="captive.profession"></span>
                                                </p>
                                                <p class="text-sm">
                                                    <span x-show="captive.isPregnant" class="text-pink-400 font-bold" x-text="`狀態: 懷孕中 (剩餘 ${captive.pregnancyTimer} 天)`"></span>
                                                    <span x-show="!captive.isPregnant && captive.isMother" class="text-blue-400 font-bold">狀態: 產奶中</span>
                                                    <span x-show="!captive.isPregnant && !captive.isMother" class="text-green-400 font-bold">狀態: 可繁衍</span>
                                                </p>
                                            </div>
                                            <input type="checkbox" :value="captive.id" x-model="modals.captiveManagement.selectedIds"
                                                    :disabled="!modals.captiveManagement.selectedIds.includes(captive.id) && modals.captiveManagement.selectedIds.length >= modals.captiveManagement.limit"
                                                    class="form-checkbox h-5 w-5 bg-gray-800 border-gray-500 text-green-500 focus:ring-green-500">
                                        </div>
                                        <div class="mt-2 pt-2 border-t border-gray-600 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                            <div><strong>力量:</strong> <span x-text="captive.stats.strength"></span></div>
                                            <div><strong>敏捷:</strong> <span x-text="captive.stats.agility"></span></div>
                                            <div><strong>智力:</strong> <span x-text="captive.stats.intelligence"></span></div>
                                            <div><strong>運氣:</strong> <span x-text="captive.stats.luck"></span></div>
                                            <div class="col-span-2"><strong>魅力:</strong>
                                                <span class="font-bold" x-text="captive.stats.charisma"></span>
                                            </div>
                                        </div>
                                        <template x-if="captive.visual">
                                            <div class="mt-2 pt-2 border-t border-gray-600 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                                <div><strong>身高:</strong> <span x-text="captive.visual.height"></span> cm</div>
                                                <div><strong>年紀:</strong> <span x-text="captive.visual.age"></span></div>
                                                <div><strong>髮色:</strong> <span x-text="captive.visual.hairColor"></span></div>
                                                <div><strong>髮型:</strong> <span x-text="captive.visual.hairStyle"></span></div>
                                                <div><strong>服裝:</strong> <span x-text="captive.visual.clothing"></span></div>
                                                <div><strong>胸圍:</strong> <span x-text="captive.visual.bust"></span></div>
                                                <template x-if="captive.race === 'elf'">
                                                    <div><strong>耳朵:</strong> <span x-text="captive.visual.elfEars"></span></div>
                                                </template>
                                                <template x-if="captive.race === 'beastkin'">
                                                    <div><strong>亞種:</strong> <span x-text="captive.visual.beastkinSubspecies"></span></div>
                                                </template>
                                                <div><strong>個性:</strong> <span x-text="captive.visual.personality"></span></div>
                                            </div>
                                        </template>
                                    </div>
                                </template>
                            </div>
                            <div class="text-right mt-6">
                                <button @click="confirmCaptiveSelection()" class="btn btn-primary">
                                    確認選擇 (<span x-text="modals.captiveManagement.selectedIds.length"></span>)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="partner-management-modal" class="modal" x-show="modals.partnerManagement.isOpen" x-cloak>
                    <div class="modal-content game-container relative p-6 rounded-lg">
                        <h2 class="game-title font-medieval">寢室空間不足</h2>
                        <div class="pt-10 max-h-[80vh] overflow-y-auto">
                            <p class="mb-4">新生兒已誕生，但寢室已滿！您必須選擇要保留的夥伴。上限: <span x-text="modals.partnerManagement.selectedIds.length"></span> /
                                <span x-text="modals.partnerManagement.limit"></span>
                            </p>
                            <div class="space-y-4 max-h-96 overflow-y-auto pr-2 border border-gray-700 rounded p-2">
                                <template x-for="partner in modals.partnerManagement.list" :key="partner.id">
                                    <div class="p-3 border rounded" :class="modals.partnerManagement.newbornId.includes(partner.id) ? 'border-yellow-400 bg-gray-700/50' : 'border-gray-600'">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="text-lg font-bold text-amber-200" x-text="partner.name"></p>
                                                <p class="text-sm text-yellow-400" x-show="modals.partnerManagement.newbornId.includes(partner.id)">（新生兒）</p>
                                            </div>
                                            <input type="checkbox" :value="partner.id" x-model="modals.partnerManagement.selectedIds"
                                                :disabled="!modals.partnerManagement.selectedIds.includes(partner.id) && modals.partnerManagement.selectedIds.length >= modals.partnerManagement.limit"
                                                class="form-checkbox h-5 w-5 bg-gray-800 border-gray-500 text-green-500 focus:ring-green-500">
                                        </div>
                                        <div class="mt-2 pt-2 border-t border-gray-700 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                            <div><strong>力量:</strong> <span x-text="partner.stats.strength"></span></div>
                                            <div><strong>敏捷:</strong> <span x-text="partner.stats.agility"></span></div>
                                            <div><strong>智力:</strong> <span x-text="partner.stats.intelligence"></span></div>
                                            <div><strong>運氣:</strong> <span x-text="partner.stats.luck"></span></div>
                                            
                                            <div class="col-span-2 mt-1 pt-1 border-t border-gray-800">
                                                <strong class="text-yellow-300">總屬性:</strong>
                                                <span class="font-bold text-yellow-300" x-text="partner.stats.strength + partner.stats.agility + partner.stats.intelligence + partner.stats.luck"></span>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                            <div class="text-right mt-6">
                                <button @click="confirmPartnerSelectionDecision()" class="btn btn-primary">
                                    確認選擇 (<span x-text="modals.partnerManagement.selectedIds.length"></span>)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 繁衍敘事 Modal -->
                <div class="modal" x-show="modals.narrative.isOpen" x-cloak>
                    <div class="modal-content game-container relative p-6 rounded-lg flex flex-col">
                        <h2 class="game-title font-medieval" x-text="modals.narrative.title"></h2>
                        <div class="pt-10 flex-grow flex flex-col max-h-[80vh]">
                            
                            <div class="flex-grow overflow-y-auto p-4 bg-black bg-opacity-20 rounded mb-4 flex items-center justify-center">

                                <div x-show="modals.narrative.type !== 'tutorial'" class="w-full">
                                    <div x-show="modals.narrative.isAwaitingConfirmation" class="text-center">
                                        <p class="mb-4" x-text="modals.narrative.content"></p>
                                        <button x-show="modals.narrative.type === 'birth'" @click="generateBirthNarrative()" class="btn btn-primary">使用 AI 生成誕生故事</button>
                                        <button x-show="modals.narrative.type === 'breeding'" @click="confirmAndStartBreedingNarrative()" class="btn btn-primary">使用 AI 生成繁衍敘事</button>
                                    </div>

                                    <div x-show="modals.narrative.isLoading" class="loader mx-auto"></div>

                                    <p x-show="!modals.narrative.isLoading && !modals.narrative.isAwaitingConfirmation" x-html="modals.narrative.content"
                                        class="text-lg leading-relaxed whitespace-pre-wrap w-full"></p>
                                </div>

                                <div x-show="modals.narrative.type === 'tutorial'" class="flex items-start gap-4 w-full">
                                    <img :src="modals.narrative.avatarUrl || 'assets/century_avatar.png'" alt="對話者頭像" class="w-24 h-24 rounded-full border-2 border-pink-400 flex-shrink-0">
                                    <div class="flex-grow text-left" x-html="modals.narrative.content">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="text-center mt-4">
                                <button 
                                    x-show="modals.narrative.type === 'tutorial'" 
                                    @click="confirmNarrativeModal()" 
                                    class="btn btn-primary">
                                    <span x-text="modals.narrative.onConfirm ? '迎戰' : '了解'"></span>
                                </button>
                            </div>

                        </div>
                    </div>
                </div>

                <!-- 自訂提示框 -->
                <div id="custom-alert-modal" x-show="modals.customAlert.isOpen" class="modal" @click.self="confirmCustomAlert()">
                    <div class="modal-content game-container relative p-6 rounded-lg max-w-sm pt-10">
                        <p class="text-center" x-text="modals.customAlert.message"></p>
                        <div class="text-center mt-4">
                            <button @click="confirmCustomAlert()" class="btn btn-primary">確定</button>
                        </div>
                    </div>
                </div>

                <!-- 丟棄確認 Modal -->
                <div id="discard-confirm-modal" x-show="modals.discardConfirm.isOpen" class="modal">
                    <div class="modal-content game-container relative p-6 rounded-lg max-w-sm pt-10">
                        <p class="text-center">確定要丟棄 <span class="font-bold" x-text="modals.discardConfirm.itemName"></span> 嗎？<br>此操作無法復原。
                        </p>
                        <div class="text-center mt-6 flex justify-center space-x-4">
                            <button @click="executeDiscardItem()" class="btn btn-danger">確定</button>
                            <button @click="modals.discardConfirm.isOpen = false" class="btn btn-secondary">取消</button>
                        </div>
                    </div>
                </div>

                <!-- Raid Status Modal -->
                <template x-if="currentlyEditingPartner">
                    <div id="partner-equipment-modal" class="modal" x-show="modals.partnerEquipment.isOpen" x-cloak >
                        <div class="modal-content !max-w-4xl game-container relative p-6 rounded-lg">
                            <h2 class="game-title font-medieval" x-text="`管理裝備 - ${currentlyEditingPartner.name}`"></h2>
                            <div class="pt-10 max-h-[80vh] overflow-y-auto">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div class="md:col-span-1 space-y-4">
                                        <h3 class="text-xl font-bold text-amber-200">已裝備</h3>
                                        <template x-for="slot in Object.keys(currentlyEditingPartner.equipment)" :key="slot">
                                            <div class="p-2 border border-gray-700 rounded">
                                                <p class="font-bold capitalize" x-text="EQUIPMENT_SLOTS[slot] || slot"></p>
                                                <template x-if="currentlyEditingPartner.equipment[slot]">
                                                    <div>
                                                        <p :style="{ color: currentlyEditingPartner.equipment[slot].quality.color }" x-text="currentlyEditingPartner.equipment[slot].name"></p>
                                                        <p class="text-xs text-gray-400" x-html="getItemStatsString(currentlyEditingPartner.equipment[slot])"></p>
                                                        <button @click="unequipItem(slot, currentlyEditingPartner)" class="btn btn-sm btn-secondary mt-1">卸下</button>
                                                    </div>
                                                </template>
                                                <template x-if="!currentlyEditingPartner.equipment[slot]">
                                                    <p class="text-gray-500">-- 空 --</p>
                                                </template>
                                            </div>
                                        </template>
                                    </div>

                                    <div class="md:col-span-2 space-y-4">
                                        <div class="flex items-center space-x-2 mb-4 border-b border-gray-600 pb-3">
                                            <span class="font-bold text-sm text-gray-400">篩選類型:</span>
                                            <button @click="modals.partnerEquipment.activeFilter = 'all'" class="btn btn-xs" :class="{ 'btn-primary': modals.partnerEquipment.activeFilter === 'all', 'btn-secondary': modals.partnerEquipment.activeFilter !== 'all' }">全部</button>
                                            <button @click="modals.partnerEquipment.activeFilter = 'weapon'" class="btn btn-xs" :class="{ 'btn-primary': modals.partnerEquipment.activeFilter === 'weapon', 'btn-secondary': modals.partnerEquipment.activeFilter !== 'weapon' }">武器</button>
                                            <button @click="modals.partnerEquipment.activeFilter = 'shield'" class="btn btn-xs" :class="{ 'btn-primary': modals.partnerEquipment.activeFilter === 'shield', 'btn-secondary': modals.partnerEquipment.activeFilter !== 'shield' }">盾牌</button>
                                            <button @click="modals.partnerEquipment.activeFilter = 'armor'" class="btn btn-xs" :class="{ 'btn-primary': modals.partnerEquipment.activeFilter === 'armor', 'btn-secondary': modals.partnerEquipment.activeFilter !== 'armor' }">鎧甲</button>
                                        </div>

                                        <div x-show="screen !== 'raid'">
                                            <h3 class="text-xl font-bold mb-2 text-amber-200">部落倉庫 (<span x-text="filteredPartnerWarehouse.length"></span> / <span x-text="warehouseCapacity"></span>)</h3>
                                            <div class="space-y-2 max-h-60 overflow-y-auto pr-2 border border-gray-700 rounded p-2">
                                                <template x-for="item in filteredPartnerWarehouse" :key="item.id">
                                                    <div class="p-3 border border-gray-600 rounded flex justify-between items-center">
                                                        <div>
                                                            <p :style="{ color: item.quality.color }" x-text="item.name"></p>
                                                            <p class="text-xs text-gray-400" x-html="getItemStatsString(item)"></p>
                                                        </div>
                                                        <button @click="equipItem(item.id, currentlyEditingPartner)" class="btn btn-sm btn-success">裝備</button>
                                                    </div>
                                                </template>
                                                <p x-show="filteredPartnerWarehouse.length === 0" class="text-center text-gray-400">倉庫是空的，或篩選結果為空。</p>
                                            </div>
                                        </div>
                                        
                                        <div>
                                            <h3 class="text-xl font-bold mb-2 text-amber-200">玩家背包 (<span x-text="filteredPartnerBackpack.length"></span> / <span x-text="backpackCapacity"></span>)</h3>
                                            <div class="space-y-2 max-h-60 overflow-y-auto pr-2 border border-gray-700 rounded p-2">
                                                <template x-for="item in filteredPartnerBackpack" :key="item.id">
                                                    <div class="p-3 border border-gray-600 rounded flex justify-between items-center">
                                                        <div>
                                                            <p :style="{ color: item.quality.color }" x-text="item.name"></p>
                                                            <p class="text-xs text-gray-400" x-html="getItemStatsString(item)"></p>
                                                        </div>
                                                        <button @click="equipItem(item.id, currentlyEditingPartner)" class="btn btn-sm btn-success">裝備</button>
                                                    </div>
                                                </template>
                                                <p x-show="filteredPartnerBackpack.length === 0" class="text-center text-gray-400">你的背包是空的，或篩選結果為空。</p>
                                            </div>
                                        </div>
                                        </div>
                                </div>
                                <div class="text-right mt-6">
                                    <button @click="modals.partnerEquipment.isOpen = false" class="btn btn-secondary">關閉</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <template x-if="player">
                    <div class="modal" x-show="modals.raidStatus.isOpen" x-cloak >
                        <div class="modal-content game-container relative p-6 rounded-lg">
                            <h2 class="game-title font-medieval">玩家狀態</h2>
                            <div class="pt-10 max-h-[80vh] overflow-y-auto">
                                <div class="flex border-b border-gray-600 mb-4">
                                    <button @click="modals.raidStatus.activeTab = 'status'" :class="{ 'bg-gray-700 text-white': modals.raidStatus.activeTab === 'status' }" class="flex-1 py-2 px-4 rounded-t-lg">狀態</button>
                                    <button @click="modals.raidStatus.activeTab = 'partners'" :class="{ 'bg-gray-700 text-white': modals.raidStatus.activeTab === 'partners' }" class="flex-1 py-2 px-4 rounded-t-lg">夥伴</button> 
                                    <button @click="modals.raidStatus.activeTab = 'inventory'" :class="{ 'bg-gray-700 text-white': modals.raidStatus.activeTab === 'inventory' }" class="flex-1 py-2 px-4 rounded-t-lg">背包</button>
                                </div>
                                <!-- Status Tab -->
                                <div x-show="modals.raidStatus.activeTab === 'status'">
                                    <div class="flex justify-between items-center mb-2">
                                        <p><strong>名稱:</strong> <span class="font-accent" x-text="player.name"></span></p>
                                        <button @click="openPlayerEquipment()" class="btn btn-sm btn-secondary">管理裝備</button>
                                    </div>
                                    <p class="mt-2 font-bold text-amber-200" :class="{'text-red-400': isStarving}">總能力值
                                        <span x-show="isStarving">(飢餓中 -25%)</span>:
                                    </p>
                                    <ul class="space-y-1 text-sm">
                                        <template x-for="stat in ['strength', 'agility', 'intelligence', 'luck']" :key="stat">
                                            <li>
                                                <div>
                                                    <span class="capitalize" x-text="STAT_NAMES[stat]"></span>:
                                                    <span x-text="player.stats[stat]"></span>
                                                    <span class="text-green-400" x-show="player.getPartyBonus(stat) > 0" x-text="` (+${player.getPartyBonus(stat)})`"></span>
                                                    
                                                    <template x-if="player.getSpecialAffixModifier(stat).bonus > 0">
                                                        <span class="text-purple-400" x-text="` (+${player.getSpecialAffixModifier(stat).bonus})`"></span>
                                                    </template>
                                                    <template x-if="player.getSpecialAffixModifier(stat).penalty > 0">
                                                        <span class="text-red-400" x-text="` (-${player.getSpecialAffixModifier(stat).penalty})`"></span>
                                                    </template>
                                                    
                                                    <span class="text-blue-400" x-show="player.getEffectiveEquipmentBonus(stat) > 0" x-text="` (+${player.getEffectiveEquipmentBonus(stat)})`"></span>
                                                    <span class="text-red-400" x-show="isStarving" x-text="` -> ${player.getTotalStat(stat, isStarving)}`"></span>
                                                </div>
                                            </li>
                                        </template>
                                    </ul>
                                    <div class="mt-2">
                                        <p><strong>生命值:</strong>
                                            <span x-text="player.currentHp"></span> / <span x-text="player.getBaseMaxHp(isStarving)"></span>
                                            <span class="text-green-400" x-show="player.getPartyHpBonus(isStarving) > 0" x-text="` (+${player.getPartyHpBonus(isStarving)})`"></span>
                                            <span class="text-blue-400" x-show="player.getEquipmentHpBonus() > 0" x-text="` (+${player.getEquipmentHpBonus()})`"></span>
                                        </p>
                                    </div>
                                </div>
                                <!-- partners Tab -->
                                <div x-show="modals.raidStatus.activeTab === 'partners'">
                                    <div class="space-y-4 max-h-96 overflow-y-auto pr-2 border border-gray-700 rounded p-2">
                                        <template x-for="partner in player.party" :key="partner.id">
                                            <div class="p-3 border border-gray-700 rounded">
                                                <p class="font-bold text-amber-200" x-text="partner.name"></p>
                                                <p><strong>生命值:</strong> <span x-text="partner.currentHp"></span> / <span x-text="partner.getBaseMaxHp(isStarving)"></span><span class="text-blue-400" x-show="partner.calculateMaxHp(isStarving) - partner.getBaseMaxHp(isStarving) !== 0" x-text="`( +${partner.calculateMaxHp(isStarving) - partner.getBaseMaxHp(isStarving)})`"></span></p>
                                                <div class="mt-2 pt-2 border-t border-gray-600 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                                    <span>力: <span x-text="partner.stats.strength"></span><span class="text-xs text-blue-400" x-text="formatBonus(partner.getTotalStat('strength', isStarving) - partner.stats.strength)"></span></span>
                                                    <span>敏: <span x-text="partner.stats.agility"></span><span class="text-xs text-blue-400" x-text="formatBonus(partner.getTotalStat('agility', isStarving) - partner.stats.agility)"></span></span>
                                                    <span>智: <span x-text="partner.stats.intelligence"></span><span class="text-xs text-blue-400" x-text="formatBonus(partner.getTotalStat('intelligence', isStarving) - partner.stats.intelligence)"></span></span>
                                                    <span>運: <span x-text="partner.stats.luck"></span><span class="text-xs text-blue-400" x-text="formatBonus(partner.getTotalStat('luck', isStarving) - partner.stats.luck)"></span></span>
                                                </div>
                                                <div class="mt-2 pt-2 border-t border-gray-600 space-y-1 text-sm">
                                                    <div class="flex justify-between items-center mb-1">
                                                        <p class="font-bold text-amber-200">裝備:</p>
                                                        <button @click="openPartnerEquipment(partner.id)" class="btn btn-xs btn-secondary">管理裝備</button>
                                                    </div>
                                                    <template x-for="slot in Object.keys(partner.equipment)" :key="slot">
                                                        <div class="pl-2">
                                                            <span class="capitalize" x-text="EQUIPMENT_SLOTS[slot] || slot"></span>:
                                                            <span x-show="partner.equipment[slot]" :style="{ color: partner.equipment[slot]?.quality.color }" x-text="partner.equipment[slot]?.name"></span>
                                                            <span x-show="!partner.equipment[slot]" class="text-gray-500">-- 無 --</span>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>
                                        </template>
                                        <p x-show="!player.party || player.party.length === 0" class="text-center text-gray-400">你沒有帶任何夥伴同行。</p>
                                    </div>
                                </div>
                                <!-- equipment Tab -->    
                                <div x-show="modals.raidStatus.activeTab === 'equipment'">
                                        <div class="grid grid-cols-2 gap-4">
                                            <template x-for="slot in Object.keys(player.equipment)" :key="slot">
                                                <div class="p-2 border border-gray-700 rounded">
                                                    <p class="font-bold capitalize" x-text="EQUIPMENT_SLOTS[slot] || slot"></p>
                                                    <template x-if="player.equipment[slot]">
                                                        <div>
                                                            <p :style="{ color: player.equipment[slot].quality.color }"
                                                                x-text="player.equipment[slot].name"></p>
                                                            <p class="text-xs text-gray-400"
                                                                x-html="getItemStatsString(player.equipment[slot])"></p>
                                                            <button @click="unequipItem(slot, player)" class="btn btn-sm btn-secondary mt-1">卸下</button>
                                                        </div>
                                                    </template>
                                                    <template x-if="!player.equipment[slot]">
                                                        <p class="text-gray-500">-- 空 --</p>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                <!-- Inventory Tab -->
                                <div x-show="modals.raidStatus.activeTab === 'inventory'">
                                    <div class="flex items-center space-x-2 mb-4 border-b border-gray-600 pb-3">
                                        <span class="font-bold text-sm text-gray-400">篩選類型:</span>
                                        <button @click="modals.raidStatus.activeFilter = 'all'" class="btn btn-xs" :class="{ 'btn-primary': modals.raidStatus.activeFilter === 'all', 'btn-secondary': modals.raidStatus.activeFilter !== 'all' }">全部</button>
                                        <button @click="modals.raidStatus.activeFilter = 'weapon'" class="btn btn-xs" :class="{ 'btn-primary': modals.raidStatus.activeFilter === 'weapon', 'btn-secondary': modals.raidStatus.activeFilter !== 'weapon' }">武器</button>
                                        <button @click="modals.raidStatus.activeFilter = 'shield'" class="btn btn-xs" :class="{ 'btn-primary': modals.raidStatus.activeFilter === 'shield', 'btn-secondary': modals.raidStatus.activeFilter !== 'shield' }">盾牌</button>
                                        <button @click="modals.raidStatus.activeFilter = 'armor'" class="btn btn-xs" :class="{ 'btn-primary': modals.raidStatus.activeFilter === 'armor', 'btn-secondary': modals.raidStatus.activeFilter !== 'armor' }">鎧甲</button>
                                    </div>
                                    <div class="space-y-2 max-h-96 overflow-y-auto pr-2 border border-gray-700 rounded p-2">
                                        <template x-for="item in filteredRaidInventory" :key="item.id">
                                            <div class="p-3 border border-gray-600 rounded flex justify-between items-center">
                                                <div>
                                                    <p :style="{ color: item.quality.color }" x-text="item.name"></p>
                                                    <p class="text-xs text-gray-400" x-html="getItemStatsString(item)"></p>
                                                </div>
                                                <div class="space-x-2">
                                                    <button @click="openDiscardConfirm(item.id)" class="btn btn-sm btn-secondary">丟棄</button>
                                                </div>
                                            </div>
                                        </template>
                                        <p x-show="filteredRaidInventory.length === 0" class="text-center text-gray-400">你的背包是空的，或篩選結果為空。</p>
                                    </div>
                                </div>
                                <div class="text-right mt-6">
                                    <button @click="modals.raidStatus.isOpen = false" class="btn btn-secondary">關閉</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>

                <div class="modal" x-show="modals.merchant.isOpen" x-cloak >
                    <div class="modal-content !max-w-4xl game-container relative p-6 rounded-lg">
                        <h2 class="game-title font-medieval">旅行商人：世紀</h2>
                        <div class="pt-10 max-h-[80vh] overflow-y-auto">
                            <div class="flex items-start p-4 mb-6 bg-black bg-opacity-20 rounded-lg border border-pink-500/30">
                                <img :src="merchant.avatar || 'assets/century_avatar.png'" alt="世紀的頭像" class="w-24 h-24 rounded-full border-2 border-pink-400 flex-shrink-0">
                                <div class="flex-grow">
                                    <h3 class="text-xl font-bold text-pink-300">旅行商人：世紀</h3>
                                    <p class="mt-2 text-pink-200 italic" x-text="merchant.dialogue"></p>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 class="text-xl font-bold mb-2 text-amber-200">商品列表 (剩餘 <span x-text="merchant.goods.length"></span> 件)</h3>
                                    <div class="space-y-2 h-96 overflow-y-auto pr-2">
                                        <template x-for="item in merchant.goods" :key="item.id">
                                            <label class="p-3 border rounded flex items-center justify-between cursor-pointer"
                                                :class="merchant.selectedItemIds.includes(item.id) ? 'border-yellow-400 bg-gray-700' : 'border-gray-600 hover:bg-gray-600'">
                                                <div>
                                                    <p :style="{ color: item.quality.color }" x-text="item.name"></p>
                                                    <p class="text-xs text-gray-400" x-html="getItemStatsString(item)"></p>
                                                    <p class="text-sm font-bold text-yellow-400 mt-1">價值: <span x-text="calculateEquipmentValue(item)"></span></p>
                                                </div>
                                                <input type="checkbox" :value="item.id" x-model="merchant.selectedItemIds"
                                                    class="form-checkbox h-5 w-5 bg-gray-800 border-gray-500 text-yellow-500 focus:ring-yellow-500">
                                            </label>
                                        </template>
                                    </div>
                                </div>
                                <div>
                                    <h3 class="text-xl font-bold mb-2 text-amber-200">你的貨幣 (俘虜)</h3>
                                    <div class="space-y-2 h-96 overflow-y-auto pr-2">
                                        <template x-for="captive in dungeonCaptives" :key="captive.id">
                                            <label class="p-3 border rounded flex items-center justify-between cursor-pointer"
                                                :class="merchant.selectedCaptiveIds.includes(captive.id) ? 'border-green-400 bg-gray-700' : 'border-gray-600 hover:bg-gray-600'">
                                                <div>
                                                    <p x-text="captive.name"></p>
                                                    <p class="text-xs text-gray-400">魅力: <span x-text="captive.stats.charisma"></span></p>
                                                    <p class="text-sm font-bold text-green-400 mt-1">價值: <span x-text="calculateCaptiveValue(captive)"></span></p>
                                                </div>
                                                <input type="checkbox" :value="captive.id" x-model="merchant.selectedCaptiveIds"
                                                    class="form-checkbox h-5 w-5 bg-gray-800 border-gray-500 text-green-500 focus:ring-green-500">
                                            </label>
                                        </template>
                                        <p x-show="dungeonCaptives.length === 0" class="text-center text-gray-400">你沒有任何俘虜可以交易。</p>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6 pt-4 border-t border-gray-600 flex justify-between items-center">
                                <div>
                                    <p>商品價值: <span class="font-bold text-yellow-400" x-text="selectedItemsValue"></span></p>
                                    <p>俘虜總價值: <span class="font-bold" :class="selectedCaptivesValue >= selectedItemsValue ? 'text-green-400' : 'text-red-400'" x-text="selectedCaptivesValue"></span></p>
                                </div>
                                <button @click="executeTrade()" class="btn btn-primary" :disabled="!canExecuteTrade">確認交易</button>
                            </div>
                            <div class="text-right mt-6">
                                <button @click="modals.merchant.isOpen = false" class="btn btn-secondary">關閉</button>
                            </div>
                        </div>
                    </div>
                </template> 

                <!-- 王座之間畫面 (2D場景版) -->
                <template x-if="screen === 'throne_room'">
                    <div id="throne-room-screen-scene" x-cloak>
                        <div class="w-full max-w-2xl mx-auto game-container relative p-6 rounded-lg pt-10">
                            <h1 class="game-title font-medieval">王座之間</h1>
                            <div class="text-center mb-4">
                                <p class="text-lg text-amber-200">公主與她的守護騎士們擋在了你的面前。</p>
                            </div>

                            <!-- 場景容器 -->
                            <div class="scene-container" x-init="
                                const scene = $el;
                                for (let i = 0; i < 30; i++) {
                                    const particle = document.createElement('div');
                                    particle.className = 'dust-particle';
                                    const size = Math.random() * 3 + 1;
                                    particle.style.width = `${size}px`;
                                    particle.style.height = `${size}px`;
                                    particle.style.top = `${Math.random() * 100}%`;
                                    particle.style.left = `${Math.random() * 100}%`;
                                    particle.style.setProperty('--tx', `${(Math.random() - 0.5) * 200}px`);
                                    particle.style.setProperty('--ty', `${(Math.random() - 0.5) * 200}px`);
                                    particle.style.animationDelay = `${Math.random() * 20}s`;
                                    particle.style.animationDuration = `${Math.random() * 10 + 15}s`;
                                    scene.appendChild(particle);
                                }
                            ">
                                <!-- 周邊石柱 -->
                                <div class="pillar" style="top: 15%; left: 15%;"></div>
                                <div class="pillar" style="top: 15%; right: 15%;"></div>
                                <div class="pillar" style="bottom: 15%; left: 15%;"></div>
                                <div class="pillar" style="bottom: 15%; right: 15%;"></div>
                                <div class="pillar" style="top: 50%; left: 5%; transform: translateY(-50%);"></div>
                                <div class="pillar" style="top: 50%; right: 5%; transform: translateY(-50%);"></div>

                                <!-- 圓形場地 -->
                                <div class="arena-floor">
                                    
                                    <!-- 王座 -->
                                    <div class="throne" style="top: 10%; left: 50%;"></div>

                                    <!-- 動態生成公主 (黃點) -->
                                    <template x-for="(unit, index) in throneRoomUnits.filter(u => u.profession === '公主')" :key="unit.id">
                                        <div @click="scoutThroneUnit(unit)" class="unit princess" :style="`top: 20%; left: ${45 + (index * 10)}%;`"></div>
                                    </template>

                                    <!-- 動態生成騎士 (橘點) -->
                                    <template x-for="unit in throneRoomUnits.filter(u => u.profession !== '公主')" :key="unit.id">
                                        <div @click="scoutThroneUnit(unit)" class="unit knight" :style="`top: ${knightPositions[unit.profession].top}; left: ${knightPositions[unit.profession].left};`"></div>
                                    </template>

                                    <!-- 玩家 (綠點) -->
                                    <div class="unit player" style="top: 90%; left: 50%;"></div>
                                </div>
                            </div>

                            <div class="mt-6 text-center">
                                <button @click="screen = 'raid'" class="btn btn-danger">撤退回王城</button>
                            </div>
                        </div>
                    </div>
                </template>
    
                <div class="modal" x-show="modals.throneScout.isOpen" x-cloak>
                    <template x-if="modals.throneScout.unit">
                        <div class="modal-content game-container relative p-6 rounded-lg">
                            <h2 class="game-title font-medieval" x-text="`偵查情報 - ${modals.throneScout.unit.name}`"></h2>
                
                            <div class="pt-10 max-h-[70vh] overflow-y-auto">
                                <p class="italic text-center text-pink-300 mb-4" x-text="getThroneUnitDialogue(modals.throneScout.unit)"></p>
                                
                                <div class="p-3 border border-gray-700 rounded">
                                    <p class="text-lg font-bold text-amber-200">
                                        <span x-text="modals.throneScout.unit.name"></span> - <span x-text="modals.throneScout.unit.profession"></span>
                                    </p>
                                    <div class="mt-2 pt-2 border-t border-gray-600 grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
                                        <div><strong>力量:</strong> <span x-text="modals.throneScout.unit.stats.strength"></span></div>
                                        <div><strong>敏捷:</strong> <span x-text="modals.throneScout.unit.stats.agility"></span></div>
                                        <div><strong>智力:</strong> <span x-text="modals.throneScout.unit.stats.intelligence"></span></div>
                                        <div><strong>運氣:</strong> <span x-text="modals.throneScout.unit.stats.luck"></span></div>
                                        <div class="col-span-2" x-show="modals.throneScout.unit.stats.charisma > 0">
                                            <strong>魅力:</strong> <span class="font-bold text-lg text-pink-400" x-text="modals.throneScout.unit.stats.charisma"></span>
                                        </div>
                                    </div>
                                    <div class="mt-2 pt-2 border-t border-gray-600 text-sm">
                                        <p class="font-bold text-amber-200">裝備:</p>
                                        <div class="space-y-1 pl-2">
                                            <template x-for="slot in Object.keys(modals.throneScout.unit.equipment || {})" :key="slot">
                                                <div>
                                                    <span class="capitalize" x-text="EQUIPMENT_SLOTS[slot] || slot"></span>:
                                                    <template x-if="modals.throneScout.unit.equipment[slot]">
                                                        <span :style="{ color: modals.throneScout.unit.equipment[slot].quality.color }" x-text="modals.throneScout.unit.equipment[slot].name"></span>
                                                    </template>
                                                    <template x-if="!modals.throneScout.unit.equipment[slot]">
                                                        <span class="text-gray-500">-- 無 --</span>
                                                    </template>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                
                            <div class="text-right mt-6 pt-4 border-t border-gray-600 space-x-2">
                                <button @click="startFinalBattle()" class="btn btn-danger">發起決戰</button>
                                <button @click="modals.throneScout.isOpen = false" class="btn btn-secondary">關閉</button>
                            </div>
                        </div>
                    </template>
                </div>
    
                <div id="item-management-modal" class="modal" x-show="modals.itemManagement.isOpen" x-cloak>
                    <div class="modal-content !max-w-3xl game-container relative p-6 rounded-lg">
                        <h2 class="game-title font-medieval" x-text="modals.itemManagement.title"></h2>
                        <div class="pt-10 max-h-[80vh] overflow-y-auto">
                            <div class="p-4 mb-4 bg-gray-900/50 border border-yellow-500/30 rounded-lg text-center">
                                <p x-text="modals.itemManagement.message"></p>
                                <p class="mt-2">
                                    <span>待處理裝備: </span>
                                    <span class="font-bold text-lg" :class="modals.itemManagement.items.length > modals.itemManagement.capacity ? 'text-red-400' : 'text-green-400'" x-text="modals.itemManagement.items.length"></span>
                                    <span> / </span>
                                    <span class="font-bold text-lg text-green-400" x-text="modals.itemManagement.capacity"></span>
                                </p>
                            </div>

                            <div class="space-y-3">
                                <template x-for="item in modals.itemManagement.items" :key="item.id">
                                    <div class="p-3 border border-gray-600 rounded flex flex-col md:flex-row justify-between items-center gap-4">
                                        <div class="flex-grow">
                                            <p :style="{ color: item.quality.color }" x-text="item.name"></p>
                                            <p class="text-xs text-gray-400" x-html="getItemStatsString(item)"></p>
                                        </div>
                                        <div class="flex-shrink-0 flex items-center gap-2">
                                            <button @click="executeItemManagementAction('decompose', item.id)" class="btn btn-sm btn-danger" :disabled="buildings.armory.level === 0" title="需要先建造兵工廠">分解</button>
                                            <button @click="executeItemManagementAction('discard', item.id)" class="btn btn-sm btn-secondary">丟棄</button>
                                        </div>
                                    </div>
                                </template>
                            </div>

                            <div class="text-center mt-6 pt-4 border-t border-gray-700">
                                <button @click="confirmItemManagement()" class="btn btn-primary" :disabled="modals.itemManagement.items.length > modals.itemManagement.capacity">
                                    確認處理
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <template x-if="modals.bailoutConfirm.isOpen">
                    <div id="bailout-confirm-modal" class="modal" @click.self="modals.bailoutConfirm.isOpen = false">
                        <div class="modal-content game-container relative p-6 rounded-lg max-w-sm pt-10">
                            <p class="text-center text-lg" x-text="modals.bailoutConfirm.messages[modals.bailoutConfirm.currentMessageIndex]"></p>
                            <div class="text-center mt-6 flex justify-center space-x-4">
                                <button @click="confirmBailoutStep()" class="btn btn-danger">是</button>
                                <button @click="refuseBailout()" class="btn btn-secondary">否</button>
                            </div>
                        </div>
                    </div>
                </template>

                <div class="modal" x-show="modals.skillTree.isOpen" x-cloak>
                    <div class="modal-content game-container relative p-6 rounded-lg">
                        <h2 class="game-title font-medieval">技能樹</h2>
                        <div class="pt-10 max-h-[80vh] overflow-y-auto">
                            <div class="flex border-b border-gray-600 mb-4 overflow-x-auto">
                                <button @click="modals.skillTree.activeTab = 'combat'" :class="{ 'bg-gray-700 text-white': modals.skillTree.activeTab === 'combat' }" class="flex-shrink-0 py-2 px-4 rounded-t-lg">戰鬥</button>
                                <button @click="modals.skillTree.activeTab = 'raiding'" :class="{ 'bg-gray-700 text-white': modals.skillTree.activeTab === 'raiding' }" class="flex-shrink-0 py-2 px-4 rounded-t-lg">掠奪</button>
                                <button @click="modals.skillTree.activeTab = 'tribe'" :class="{ 'bg-gray-700 text-white': modals.skillTree.activeTab === 'tribe' }" class="flex-shrink-0 py-2 px-4 rounded-t-lg">部落</button>
                                <button @click="modals.skillTree.activeTab = 'breeding'" :class="{ 'bg-gray-700 text-white': modals.skillTree.activeTab === 'breeding' }" class="flex-shrink-0 py-2 px-4 rounded-t-lg">繁衍</button>
                            </div>

                            <template x-if="player">
                                <div class="space-y-3 pr-2 min-h-[400px] max-h-[60vh] overflow-y-auto">
                                    <template x-for="skill in SKILL_TREES[modals.skillTree.activeTab]" :key="skill.id">

                                        <div class="p-4 border rounded-lg transition-all"
                                            :class="{
                                                'border-gray-600 opacity-60': getSkillStatus(skill) === 'locked',
                                                'border-green-400 bg-green-900/20': getSkillStatus(skill) === 'learnable',
                                                'border-blue-400 bg-blue-900/20': getSkillStatus(skill) === 'upgradeable',
                                                'border-yellow-400 bg-yellow-900/20': getSkillStatus(skill) === 'maxed'
                                            }">
                                            <div class="flex justify-between items-start">
                                                <div class="flex-grow">
                                                    <h4 class="text-lg font-bold"
                                                        :class="{
                                                            'text-green-300': getSkillStatus(skill) === 'learnable',
                                                            'text-blue-300': getSkillStatus(skill) === 'upgradeable',
                                                            'text-yellow-300': getSkillStatus(skill) === 'maxed'
                                                        }">
                                                        <span x-text="skill.name"></span>
                                                        <template x-if="player.learnedSkills[skill.id]">
                                                            <span x-text="` (Lv.${player.learnedSkills[skill.id]} / ${skill.maxLevel})`"></span>
                                                        </template>
                                                    </h4>
                                                    <p class="text-sm text-gray-300 mt-1" x-text="skill.description"></p>
                                                    <p class="text-sm text-cyan-400 mt-2 font-semibold" x-html="getSkillDisplayInfo(skill)"></p>
                                                    <p class="text-xs text-gray-500 mt-2">
                                                        <template x-if="skill.dependencies.length > 0">
                                                            <span>前置: <span x-text="skill.dependencies.map(id => Object.values(SKILL_TREES).flat().find(s => s.id === id)?.name || '').join(', ')"></span></span>
                                                        </template>
                                                    </p>
                                                </div>
                                                <div class="flex-shrink-0 ml-4 text-right">
                                                    <p class="font-bold" x-show="getSkillStatus(skill) !== 'maxed'">
                                                        花費: <span x-text="skill.levels[player.learnedSkills[skill.id] || 0]?.cost"></span> 點
                                                    </p>
                                                    <button @click="learnSkill(skill.id)"
                                                            class="btn btn-sm mt-2"
                                                            :class="{
                                                                'btn-primary': getSkillStatus(skill) === 'learnable',
                                                                'btn-success': getSkillStatus(skill) === 'upgradeable',
                                                                'btn-secondary': ['locked', 'maxed'].includes(getSkillStatus(skill))
                                                            }"
                                                            :disabled="!['learnable', 'upgradeable'].includes(getSkillStatus(skill))">
                                                        <span x-text="{learnable: '學習', upgradeable: '升級', maxed: '已滿級', locked: '鎖定'}[getSkillStatus(skill)]"></span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </template>

                            <div class="text-right mt-6">
                                <button @click="modals.skillTree.isOpen = false" class="btn btn-secondary">關閉</button>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </template>

        <template x-if="player">
            <div id="help-widget-container"
                :style="`top: ${helpWidget.position.y}px; left: ${helpWidget.position.x}px;`"
                :class="{ 'minimized': helpWidget.isMinimized && !helpWidget.isOpen, 'dragging': helpWidget.isDragging, 'opens-left': helpWidget.opensToLeft }"
                x-ref="helpWidget"
                @mousedown="initDraggableWidget($event, $refs.helpWidget)"
                @touchstart="initDraggableWidget($event, $refs.helpWidget)">

                <button
                    x-show="!helpWidget.isOpen"
                    @click.stop="toggleHelpWidget()"
                    @mouseover="helpWidget.isMinimized = false"
                    class="help-widget-button">
                    <span>?</span>
                </button>

                <div x-show="helpWidget.isOpen" @click.outside="helpWidget.isOpen = false" class="help-widget-panel" @mousedown.stop @touchstart.stop>
                    <div class="help-widget-header">
                        <h3 class="font-medieval text-xl text-amber-200">輔助說明</h3>
                        <button @click="toggleHelpWidget()" class="close-button">&times;</button>
                    </div>
                    <div class="help-widget-body">
                        <div class="help-tabs">
                            <button @click="helpWidget.activeTab = 'basic'" :class="{'active': helpWidget.activeTab === 'basic'}">基礎</button>
                            <button @click="helpWidget.activeTab = 'tribe'" :class="{'active': helpWidget.activeTab === 'tribe'}">部落</button>
                            <button @click="helpWidget.activeTab = 'raid'" :class="{'active': helpWidget.activeTab === 'raid'}">掠奪</button>
                            <button @click="helpWidget.activeTab = 'combat'" :class="{'active': helpWidget.activeTab === 'combat'}">戰鬥</button>
                        </div>
                        <div class="help-content">
                            <div x-show="helpWidget.activeTab === 'basic'">
                                <h4 class="font-bold text-lg mb-2">裝備系統核心</h4>
                                <p class="mb-4">裝備是提升戰力的主要來源，其強度由「品質」、「材質（階級）」和「詞綴」共同決定。</p>

                                <h5 class="font-bold text-md mb-2 text-amber-200">1. 裝備品質</h5>
                                <table class="w-full text-left border-collapse table-auto mb-6">
                                    <thead>
                                        <tr class="bg-gray-700">
                                            <th class="border border-gray-600 p-2">品質</th>
                                            <th class="border border-gray-600 p-2">顏色</th>
                                            <th class="border border-gray-600 p-2">品質加成</th>
                                            <th class="border border-gray-600 p-2">詞綴數量</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td class="border border-gray-600 p-2">破舊</td>
                                            <td class="border border-gray-600 p-2" style="color: #9ca3af;">灰色</td>
                                            <td class="border border-gray-600 p-2">-1</td>
                                            <td class="border border-gray-600 p-2">0</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-600 p-2">普通</td>
                                            <td class="border border-gray-600 p-2" style="color: #ffffff;">白色</td>
                                            <td class="border border-gray-600 p-2">0</td>
                                            <td class="border border-gray-600 p-2">0-1</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-600 p-2">精良</td>
                                            <td class="border border-gray-600 p-2" style="color: #4ade80;">綠色</td>
                                            <td class="border border-gray-600 p-2">+1</td>
                                            <td class="border border-gray-600 p-2">1</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-600 p-2">稀有</td>
                                            <td class="border border-gray-600 p-2" style="color: #60a5fa;">藍色</td>
                                            <td class="border border-gray-600 p-2">+2</td>
                                            <td class="border border-gray-600 p-2">2</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-600 p-2">史詩</td>
                                            <td class="border border-gray-600 p-2" style="color: #a78bfa;">紫色</td>
                                            <td class="border border-gray-600 p-2">+3</td>
                                            <td class="border border-gray-600 p-2">3</td>
                                        </tr>
                                        <tr>
                                            <td class="border border-gray-600 p-2">傳說</td>
                                            <td class="border border-gray-600 p-2" style="color: #f97316;">橘色</td>
                                            <td class="border border-gray-600 p-2">+5</td>
                                            <td class="border border-gray-600 p-2">3-4</td>
                                        </tr>
                                    </tbody>
                                </table>

                                <h5 class="font-bold text-md mb-2 text-amber-200">2. 武器基礎傷害 (依材質階級 T1-T7)</h5>
                                <table class="w-full text-left border-collapse table-auto mb-6 text-sm">
                                    <thead>
                                        <tr class="bg-gray-700">
                                            <th class="border border-gray-600 p-2">武器類型</th>
                                            <th class="border border-gray-600 p-2 text-center">T1</th>
                                            <th class="border border-gray-600 p-2 text-center">T2</th>
                                            <th class="border border-gray-600 p-2 text-center">T3</th>
                                            <th class="border border-gray-600 p-2 text-center">T4</th>
                                            <th class="border border-gray-600 p-2 text-center">T5</th>
                                            <th class="border border-gray-600 p-2 text-center">T6</th>
                                            <th class="border border-gray-600 p-2 text-center">T7</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td class="border border-gray-600 p-2">劍/彎刀 (力)</td><td class="border border-gray-600 p-2 text-center">10</td><td class="border border-gray-600 p-2 text-center">15</td><td class="border border-gray-600 p-2 text-center">23</td><td class="border border-gray-600 p-2 text-center">35</td><td class="border border-gray-600 p-2 text-center">53</td><td class="border border-gray-600 p-2 text-center">80</td><td class="border border-gray-600 p-2 text-center">120</td></tr>
                                        <tr><td class="border border-gray-600 p-2">斧頭 (力)</td><td class="border border-gray-600 p-2 text-center">11</td><td class="border border-gray-600 p-2 text-center">17</td><td class="border border-gray-600 p-2 text-center">26</td><td class="border border-gray-600 p-2 text-center">39</td><td class="border border-gray-600 p-2 text-center">58</td><td class="border border-gray-600 p-2 text-center">87</td><td class="border border-gray-600 p-2 text-center">130</td></tr>
                                        <tr><td class="border border-gray-600 p-2">雙手劍 (力)</td><td class="border border-gray-600 p-2 text-center">16</td><td class="border border-gray-600 p-2 text-center">24</td><td class="border border-gray-600 p-2 text-center">36</td><td class="border border-gray-600 p-2 text-center">54</td><td class="border border-gray-600 p-2 text-center">81</td><td class="border border-gray-600 p-2 text-center">122</td><td class="border border-gray-600 p-2 text-center">183</td></tr>
                                        <tr><td class="border border-gray-600 p-2">長槍/弓/法杖 (運/敏/智)</td><td class="border border-gray-600 p-2 text-center">12</td><td class="border border-gray-600 p-2 text-center">18</td><td class="border border-gray-600 p-2 text-center">27</td><td class="border border-gray-600 p-2 text-center">41</td><td class="border border-gray-600 p-2 text-center">62</td><td class="border border-gray-600 p-2 text-center">93</td><td class="border border-gray-600 p-2 text-center">140</td></tr>
                                        <tr><td class="border border-gray-600 p-2">短刀 (敏)</td><td class="border border-gray-600 p-2 text-center">8</td><td class="border border-gray-600 p-2 text-center">12</td><td class="border border-gray-600 p-2 text-center">18</td><td class="border border-gray-600 p-2 text-center">27</td><td class="border border-gray-600 p-2 text-center">41</td><td class="border border-gray-600 p-2 text-center">62</td><td class="border border-gray-600 p-2 text-center">93</td></tr>
                                        <tr><td class="border border-gray-600 p-2">長鞭 (敏)</td><td class="border border-gray-600 p-2 text-center">9</td><td class="border border-gray-600 p-2 text-center">14</td><td class="border border-gray-600 p-2 text-center">21</td><td class="border border-gray-600 p-2 text-center">32</td><td class="border border-gray-600 p-2 text-center">48</td><td class="border border-gray-600 p-2 text-center">72</td><td class="border border-gray-600 p-2 text-center">108</td></tr>
                                        <tr><td class="border border-gray-600 p-2">爪/拐棍 (敏)</td><td class="border border-gray-600 p-2 text-center">7</td><td class="border border-gray-600 p-2 text-center">11</td><td class="border border-gray-600 p-2 text-center">17</td><td class="border border-gray-600 p-2 text-center">26</td><td class="border border-gray-600 p-2 text-center">39</td><td class="border border-gray-600 p-2 text-center">59</td><td class="border border-gray-600 p-2 text-center">88</td></tr>
                                        <tr><td class="border border-gray-600 p-2">投石索 (敏)</td><td class="border border-gray-600 p-2 text-center">6</td><td class="border border-gray-600 p-2 text-center">9</td><td class="border border-gray-600 p-2 text-center">14</td><td class="border border-gray-600 p-2 text-center">21</td><td class="border border-gray-600 p-2 text-center">32</td><td class="border border-gray-600 p-2 text-center">48</td><td class="border border-gray-600 p-2 text-center">72</td></tr>
                                    </tbody>
                                </table>

                                <h5 class="font-bold text-md mb-2 text-amber-200">3. 防具與盾牌基礎數值</h5>
                                <p class="text-sm text-gray-400 mb-2">鎧甲提供少量全屬性與高傷害減免；皮甲提供中量全屬性與中傷害減免；布服提供大量全屬性與低傷害減免。</p>
                                <table class="w-full text-left border-collapse table-auto mb-6 text-sm">
                                    <thead>
                                        <tr class="bg-gray-700">
                                            <th class="border border-gray-600 p-2">類型</th>
                                            <th class="border border-gray-600 p-2">T1</th>
                                            <th class="border border-gray-600 p-2">T2</th>
                                            <th class="border border-gray-600 p-2">T3</th>
                                            <th class="border border-gray-600 p-2">T4</th>
                                            <th class="border border-gray-600 p-2">T5</th>
                                            <th class="border border-gray-600 p-2">T6</th>
                                            <th class="border border-gray-600 p-2">T7</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td class="border border-gray-600 p-2">鎧甲 (傷害減免%)</td><td class="border border-gray-600 p-2">6</td><td class="border border-gray-600 p-2">12</td><td class="border border-gray-600 p-2">18</td><td class="border border-gray-600 p-2">24</td><td class="border border-gray-600 p-2">30</td><td class="border border-gray-600 p-2">36</td><td class="border border-gray-600 p-2">42</td></tr>
                                        <tr><td class="border border-gray-600 p-2">皮甲 (傷害減免%)</td><td class="border border-gray-600 p-2">4</td><td class="border border-gray-600 p-2">8</td><td class="border border-gray-600 p-2">12</td><td class="border border-gray-600 p-2">16</td><td class="border border-gray-600 p-2">20</td><td class="border border-gray-600 p-2">24</td><td class="border border-gray-600 p-2">28</td></tr>
                                        <tr><td class="border border-gray-600 p-2">布服 (傷害減免%)</td><td class="border border-gray-600 p-2">2</td><td class="border border-gray-600 p-2">4</td><td class="border border-gray-600 p-2">6</td><td class="border border-gray-600 p-2">8</td><td class="border border-gray-600 p-2">10</td><td class="border border-gray-600 p-2">12</td><td class="border border-gray-600 p-2">14</td></tr>
                                        <tr><td class="border border-gray-600 p-2">盾牌 (格擋目標值)</td><td class="border border-gray-600 p-2">19</td><td class="border border-gray-600 p-2">18</td><td class="border border-gray-600 p-2">17</td><td class="border border-gray-600 p-2">16</td><td class="border border-gray-600 p-2">15</td><td class="border border-gray-600 p-2">14</td><td class="border border-gray-600 p-2">13</td></tr>
                                    </tbody>
                                </table>

                                <h5 class="font-bold text-md mb-2 text-amber-200">4. 裝備詞綴</h5>
                                <table class="w-full text-left border-collapse table-auto text-sm">
                                    <thead>
                                        <tr class="bg-gray-700">
                                            <th class="border border-gray-600 p-2">詞綴名稱</th>
                                            <th class="border border-gray-600 p-2">效果</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr><td class="border border-gray-600 p-2">力量的/蠻力的</td><td class="border border-gray-600 p-2">力量 +10 / +20</td></tr>
                                        <tr><td class="border border-gray-600 p-2">敏捷的/迅捷的</td><td class="border border-gray-600 p-2">敏捷 +10 / +20</td></tr>
                                        <tr><td class="border border-gray-600 p-2">智力的/睿智的</td><td class="border border-gray-600 p-2">智力 +10 / +20</td></tr>
                                        <tr><td class="border border-gray-600 p-2">幸運的/強運的</td><td class="border border-gray-600 p-2">運氣 +10 / +20</td></tr>
                                        <tr><td class="border border-gray-600 p-2">健康的/健壯的</td><td class="border border-gray-600 p-2">生命 +240 / +480</td></tr>
                                        <tr><td class="border border-gray-600 p-2">哥布林的/哥布林王的</td><td class="border border-gray-600 p-2">全能力 +5 / +10</td></tr>
                                        <tr><td class="border border-gray-600 p-2">單手劍/巨劍的</td><td class="border border-gray-600 p-2">力量系武器傷害 +10% / +30%</td></tr>
                                        <tr><td class="border border-gray-600 p-2">弓箭/法杖/長槍的</td><td class="border border-gray-600 p-2">對應武器類型傷害 +20%</td></tr>
                                        <tr><td class="border border-gray-600 p-2">吸血的/尖刺的/連擊的</td><td class="border border-gray-600 p-2">10%/10%/5%機率 觸發 吸血/反傷/連擊</td></tr>
                                        <tr><td class="border border-gray-600 p-2">毀滅的</td><td class="border border-gray-600 p-2">爆擊基礎倍率 +0.5</td></tr>
                                        <tr><td class="border border-gray-600 p-2">再生的/格擋的/穿透的</td><td class="border border-gray-600 p-2">每回合恢復5%HP / 5%機率格擋 / 10%機率穿甲</td></tr>
                                        <tr><td class="border border-gray-600 p-2">爆擊的</td><td class="border border-gray-600 p-2">爆擊率 +10%</td></tr>
                                        <tr><td class="border border-gray-600 p-2">賭徒的</td><td class="border border-gray-600 p-2">所有機率性詞綴發動率 +5%</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <div x-show="helpWidget.activeTab === 'tribe'">
                                <h4 class="font-bold text-lg mb-2">部落經營</h4>
                                <p>這裡是部落經營的說明文字...</p>
                            </div>
                            <div x-show="helpWidget.activeTab === 'raid'">
                                <h4 class="font-bold text-lg mb-2">出擊掠奪</h4>
                                <p>這裡是出擊掠奪的說明文字...</p>
                            </div>
                            <div x-show="helpWidget.activeTab === 'combat'">
                                <h4 class="font-bold text-lg mb-2">戰鬥系統</h4>
                                <p>這裡是戰鬥系統的說明文字...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </template>

        <script src="js/00_constants_and_utils.js"></script>
        <script src="js/01_classes.js"></script>
        
        <script src="js/modules/combat.js"></script> 
        <script src="js/modules/raid.js"></script>
        <script src="js/modules/tribe.js"></script>
        <script src="js/modules/item.js"></script>
        <script src="js/modules/unitManager.js"></script>
        <script src="js/modules/narrative.js"></script>
        <script src="js/modules/ui.js"></script>
        <script src="js/modules/skill.js"></script>
        <script src="js/modules/helpWidget.js"></script>
        <script src="js/02_game_logic.js"></script>
        <script src="js/game.js"></script>
        <script>
            document.addEventListener('alpine:init', () => {
                Alpine.data('game', game);
            });
        </script>
    </div>
</body>
</html>